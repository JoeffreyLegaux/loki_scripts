SUBROUTINE ACNEBSM_OPENACC (YDCST, YDPHY0, KIDIA, KFDIA, KLON, KTDIA, KLEV, PT, PQ, PQL, PQI, PAPHI, PAPRSF, PCP, PR, PGM,  &
& YDSTA, PQCS, PNEBS, PRHCRI, PICE, PQSATS, YDSTACK)
  !-----------------------------------------------------------------------
  ! - INPUT -
  ! - OUTPUT -
  
  !**** *ACNEBSM* - CALCUL DU SEUIL D'HUMIDITE CRITIQUE, DE LA
  !                 NEBULOSITE ET DE CONDENSATION - EVAPORATION
  !                 SELON SMITH, QJRMS 90.
  !                 COMPUTATION OF CRITICAL RELATIVE HUMIDITY,
  !                 CLOUDINESS AND CONDENSATION - EVAPORATION
  !                 FROM SMITH (QJRMS, 1990).
  
  !**   Interface.
  !     ----------
  !        *CALL* *ACNEBSM*
  
  ! -   ARGUMENTS D'ENTREE.
  !     -------------------
  
  ! - NOM DES PARAMETRES DE DIMENSIONNEMENT DE LA PHYSIQUE.
  
  ! KIDIA      : INDICE DE DEPART DES BOUCLES VECTORISEES SUR L'HORIZONT..
  !            : START OF HORIZONTAL LOOP
  ! KFDIA      : INDICE DE FIN DES BOUCLES VECTORISEES SUR L'HORIZONTALE.
  !            : END OF HORIZONTAL LOOP
  ! KLON       : DIMENSION HORIZONTALE DES TABLEAUX.
  !            : HORIZONTAL DIMENSION
  ! KTDIA      : INDICE DE DEPART DES BOUCLES VERTICALES.
  !            : START OF THE VERTICAL LOOP IN THE PHYSICS.
  ! KLEV       : DIMENSION VERTICALE DES TABLEAUX "FULL LEVEL".
  !            : END OF VERTICAL LOOP AND VERTICAL DIMENSION
  
  ! - 1D (1:KLEV) .
  
  ! PGM        : FACTEUR D'ECHELLE.
  !            : MAPPING FACTOR.
  ! PVETAF     : COORDONNEE VERTICALE ETA.
  !            : VERTICAL COORDINATE ETA.
  
  ! - 2D (0:KLEV) .
  
  ! PAPHI      : GEOPOTENTIEL AUX DEMI-NIVEAUX.
  !            : GEOPOTENTIAL ON HALF-LEVELS.
  
  ! - 2D (1:KLEV) .
  
  ! PT         : TEMPERATURE
  !            : TEMPERATURE
  ! PQ         : HUMIDITE SPECIFIQUE DE LA VAPEUR D'EAU.
  !            : SPECIFIC HUMIDITY OF WATER VAPOUR.
  ! PQL        : HUMIDITE SPECIFIQUE DE L'EAU CONDENSEE LIQUIDE.
  !            : SPECIFIC HUMIDITY OF LIQUID CONDENSATED WATER.
  ! PQI        : HUMIDITE SPECIFIQUE DE L'EAU CONDENSEE GLACE.
  !            : SPECIFIC HUMIDITY OF SOLID CONDENSATED WATER.
  ! PAPRSF     : PRESSION AUX NIVEAUX DES COUCHES.
  !            : PRESSURE ON FULL LEVELS.
  ! PCP        : CHALEUR MASSIQUE A PRESSION CONSTANTE DE L'AIR.
  !            : SPECIFIC HEAT AT CONSTANT PRESSURE FOR AIR.
  ! PR         : CONSTANTE DES GAZ POUR L'AIR.
  !            : GAS CONSTANT FOR AIR.
  
  ! -   ARGUMENTS DE SORTIE.
  !     --------------------
  
  ! - 2D (1:KLEV) .
  
  ! PQCS       : CONTENU "STRATIFORME" EN CONDENSAT NUAGEUX (LIQ. + SOL.).
  !            : STRATIRORM CLOUD WATER (LIQUID + SOLID).
  ! PNEBS      : NEBULOSITE PARTIELLE STRATIFORME APRES AJUSTEMENT.
  !            : STRATIFORM FRACTIONAL CLOUDINESS APRES AJUSTEMENT.
  ! PRHCRI     : HUMIDITE CRITIQUE POUR AJUSTEMENT.
  !            : CRITICAL HUMIDITY FOR ADJUSTMENT.
  ! PICE       : PROPORTION DE LA GLACE.
  !            : PROPORTION OF ICE.
  ! PQSATS     : HUMIDITE SPECIFIQUE DE SATURATION.
  !            : SPECIFIC HUMIDITY OF SATURATION.
  
  !-----------------------------------------------------------------------
  
  !     Auteur.
  !     -------
  !     99-07, Philippe Lopez, CNRM/GMME/RECYF
  
  !     Modifications.
  !     --------------
  !        M.Hamrud      01-Oct-2003 CY28 Cleaning
  !     2004-10-15, F. Bouyssel : Introduction of PGM
  !     2005-03-03, F. Bouyssel : Improve consistency between Ns and Qs
  !                             : Qsat(Tl,P) instead of Qsat(T,P)
  !     2005-07-18, F. Bouyssel : Introduction of RFACNSM (change in cloudiness)
  !                             : Modification of RHcrit above RETAMIN
  !     2005-09-26, F. Bouyssel : Introduction of RQCRNS (change in Qc0,Neb0)
  !     2005-11-10, F. Bouyssel : Vertical smoothing of cloudiness (LNSMLIS)
  !     2006-01-25, F. Bouyssel : Modification in the use of RFACNSM
  !     2006-10-30, F. Bouyssel : Autoconversion before radiation
  !     2012-02-22, R. Brozkova : Cleaning obsolet options (LNSMLIS, LAUTONEB)
  !     2012-12-12, F. Bouyssel : Limitation on PNEBS as done before
  !     T. Wilhelmsson (Sept 2013) Geometry and setup refactoring.
  !     2016-10-04, P. Marguinaud : Port to single precision
  !     R. El Khatib 22-Jun-2022 A contribution to simplify phasing after the refactoring of YOMCLI/YOMCST/YOETHF.
  !-----------------------------------------------------------------------
  
!$acc routine( ACNEBSM_OPENACC ) seq
  
  USE PARKIND1, ONLY: JPIM, JPRB, JPRD
  USE YOMHOOK, ONLY: LHOOK, DR_HOOK, JPHOOK
  
  USE YOMCST, ONLY: TCST
  USE YOMPHY0, ONLY: TPHY0
  USE YOMSTA, ONLY: TSTA
  
  USE STACK_MOD
#include "stack.h"
  
  IMPLICIT NONE
  
  TYPE(TCST), INTENT(IN) :: YDCST
  TYPE(TPHY0), INTENT(IN) :: YDPHY0
  INTEGER(KIND=JPIM), INTENT(IN) :: KIDIA
  INTEGER(KIND=JPIM), INTENT(IN) :: KFDIA
  INTEGER(KIND=JPIM), INTENT(IN) :: KLON
  INTEGER(KIND=JPIM), INTENT(IN) :: KTDIA
  INTEGER(KIND=JPIM), INTENT(IN) :: KLEV
  REAL(KIND=JPRB), INTENT(IN) :: PGM(KLON)
  TYPE(TSTA), INTENT(IN) :: YDSTA
  REAL(KIND=JPRB), INTENT(IN) :: PAPHI(KLON, 0:KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PT(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PQ(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PQL(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PQI(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PAPRSF(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PCP(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PR(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(OUT) :: PQCS(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(OUT) :: PNEBS(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PRHCRI(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PICE(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PQSATS(KLON, KLEV)
  
  REAL(KIND=JPRB) :: ZRHCRI1
  REAL(KIND=JPRB) :: ZA
  REAL(KIND=JPRB) :: ZB
  REAL(KIND=JPRB) :: ZC
  REAL(KIND=JPRB) :: ZVETAF
  REAL(KIND=JPRB) :: ZFACT
  REAL(KIND=JPRB) :: ZFACT0
  REAL(KIND=JPRB) :: ZFACTA
  REAL(KIND=JPRB) :: ZFACTB
  REAL(KIND=JPRB) :: ZFACTC
  REAL(KIND=JPRB) :: ZEPS1
  REAL(KIND=JPRB) :: ZRHC
  REAL(KIND=JPRB) :: ZRATQ
  REAL(KIND=JPRB) :: ZSQRT6
  REAL(KIND=JPRB) :: ZRDSRV
  REAL(KIND=JPRB) :: ZQL
  REAL(KIND=JPRB) :: ZQI
  REAL(KIND=JPRB) :: ZLV
  REAL(KIND=JPRB) :: ZLS
  REAL(KIND=JPRB) :: ZLEFF
  REAL(KIND=JPRB) :: ZTLIQ
  REAL(KIND=JPRB) :: ZSIGS
  REAL(KIND=JPRB) :: ZRAT2
  REAL(KIND=JPRB) :: ZQC
  REAL(KIND=JPRB) :: ZQCS
  REAL(KIND=JPRB) :: ZESAT
  REAL(KIND=JPRB) :: ZESP
  REAL(KIND=JPRB) :: ZQSAT
  INTEGER(KIND=JPIM) :: JLON
  INTEGER(KIND=JPIM) :: JLEV
  REAL(KIND=JPHOOK) :: ZHOOK_HANDLE
  
#include "fcttrm.func.h"
#include "fctdoi.func.h"
  TYPE(STACK), INTENT(IN) :: YDSTACK
  TYPE(STACK) :: YLSTACK
  YLSTACK = YDSTACK
  JLON = KIDIA
  
  !     ------------------------------------------------------------------
  !     ------------------------------------------------------------------
  
  !     I - CRITICAL RELATIVE HUMIDITY PROFILE DEPENDENT ON THE LOCAL RESOLUTION.
  
  ZFACT0 = (YDPHY0%RETAMIN*(YDPHY0%RETAMIN - 1.0_JPRB))**2
  ZFACTA = (2.0_JPRB*YDPHY0%RETAMIN - 1.0_JPRB)
  ZFACTB = (1.0_JPRB - 3._JPRB*YDPHY0%RETAMIN**2)
  ZFACTC = (3._JPRB*YDPHY0%RETAMIN - 2.0_JPRB)*YDPHY0%RETAMIN
  
  ZRHCRI1 = YDPHY0%RHCRIT1 + (YDPHY0%RHCRIT2 - YDPHY0%RHCRIT1)*YDPHY0%GRHCMOD*EXP(-1.0_JPRB / (YDPHY0%TEQH*PGM(JLON)))
  ZFACT = (YDPHY0%RHCRIT2 - ZRHCRI1) / ZFACT0
  ZA = ZFACTA*ZFACT
  ZB = ZFACTB*ZFACT
  ZC = ZFACTC*ZFACT
  
  DO JLEV=KTDIA,KLEV
    !DEC$ IVDEP
    ZVETAF = MAX(YDSTA%SVETAF(JLEV), YDPHY0%RETAMIN)
    PRHCRI(JLON, JLEV) = ZA*ZVETAF**3 + ZB*ZVETAF**2 + ZC*ZVETAF + YDPHY0%RHCRIT2
  END DO
  
  !     II - CALCUL DE LA CONDENSATION - EVAPORATION ET DE LA NEBULOSITE
  !          COMPUTATION OF CONDENSATION - EVAPORATION AND CLOUDINESS
  !          FROM SMITH (QJRMS, 1990).
  
  IF (JPRB == JPRD) THEN
    ZEPS1 = 1.E-12_JPRB
  ELSE
    ZEPS1 = 1.E-06_JPRB
  END IF
  ZSQRT6 = SQRT(6._JPRB)
  ZRDSRV = YDCST%RD / YDCST%RV
  
  DO JLEV=KTDIA,KLEV
    !
    ZRHC = PRHCRI(JLON, JLEV)
    ZQL = PQL(JLON, JLEV)
    ZQI = PQI(JLON, JLEV)
    ZQC = ZQL + ZQI
    PICE(JLON, JLEV) = FONICE(PT(JLON, JLEV), YDPHY0%RDTFAC)
    ZLV = FOLH(PT(JLON, JLEV), 0.0_JPRB)
    ZLS = FOLH(PT(JLON, JLEV), 1.0_JPRB)
    ZLEFF = ZLV*(1.0_JPRB - PICE(JLON, JLEV)) + ZLS*PICE(JLON, JLEV)
    ZTLIQ = PT(JLON, JLEV) - (ZLV*ZQL + ZLS*ZQI) / PCP(JLON, JLEV)
    ZESAT = FOEW(ZTLIQ, 0.0_JPRB)*(1.0_JPRB - PICE(JLON, JLEV)) + FOEW(ZTLIQ, 1.0_JPRB)*PICE(JLON, JLEV)
    ZESP = ZESAT / PAPRSF(JLON, JLEV)
    ZQSAT = FOQS(ZESP)
    PQSATS(JLON, JLEV) = ZQSAT
    !
    ZSIGS =  &
    & (1.0_JPRB - ZRHC) / ZSQRT6*ZQSAT / (1.0_JPRB + ZLEFF*ZLEFF*ZQSAT*ZRDSRV / PR(JLON, JLEV) / ZTLIQ / ZTLIQ / PCP(JLON, JLEV))
    !
    ZRATQ = (PQ(JLON, JLEV) + ZQC) / ZQSAT
    ZRAT2 = (ZRATQ - 1.0_JPRB) / (1.0_JPRB - ZRHC)
    !
    IF (ZRATQ <= ZRHC) THEN
      ZQCS = 0.0_JPRB
      PNEBS(JLON, JLEV) = 0.0_JPRB
    ELSE IF (ZRATQ <= 1.0_JPRB .and. ZRATQ > ZRHC) THEN
      ZQCS = (1.0_JPRB + ZRAT2)**3 / ZSQRT6
      PNEBS(JLON, JLEV) = 0.5_JPRB*(1.0_JPRB + ZRAT2)**2
    ELSE IF (ZRATQ < (2.0_JPRB - ZRHC) .and. ZRATQ > 1.0_JPRB) THEN
      ZQCS = ZRAT2*ZSQRT6 + (1.0_JPRB - ZRAT2)**3 / ZSQRT6
      PNEBS(JLON, JLEV) = 1.0_JPRB - 0.5_JPRB*(1.0_JPRB - ZRAT2)**2
    ELSE
      ZQCS = ZRAT2*ZSQRT6
      PNEBS(JLON, JLEV) = 1.0_JPRB
    END IF
    !
    PQCS(JLON, JLEV) = YDPHY0%RSURF(JLEV)*ZQCS*ZSIGS
    PNEBS(JLON, JLEV) = YDPHY0%RSURF(JLEV)*PNEBS(JLON, JLEV)*YDPHY0%RFACNSM
    PNEBS(JLON, JLEV) = MIN(1.0_JPRB - ZEPS1, MAX(PNEBS(JLON, JLEV), ZEPS1))
    !
  END DO
  
END SUBROUTINE ACNEBSM_OPENACC
