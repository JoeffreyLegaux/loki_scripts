SUBROUTINE CUFLXN_OPENACC (YDTHF, YDCST, YDEPHLI, YDECUMF, KIDIA, KFDIA, KLON, KLEV, PTSPHY, PTEN, PQEN, PQSEN, PTENH, PQENH,  &
& PAPH, PAP, PGEOH, LDLAND, LDCUM, LDTDKMF, KCBOT, KCTOP, KDTOP, KTOPM2, KTYPE, LDDRAF, PMFU, PMFD, PMFUS, PMFDS, PMFUQ, PMFDQ,  &
& PMFUL, PLUDE, PLUDELI, PLRAIN, PSNDE, PDMFUP, PDMFDP, PDPMEL, PLGLAC, PMFLXR, PMFLXS, PRAIN, PMFUDE_RATE, PMFDDE_RATE, YDSTACK)
  
  !          PURPOSE
  !          -------
  
  !          THIS ROUTINE DOES THE FINAL CALCULATION OF CONVECTIVE
  !          FLUXES IN THE CLOUD LAYER AND IN THE SUBCLOUD LAYER
  
  !          INTERFACE
  !          ---------
  !          THIS ROUTINE IS CALLED FROM *CUMASTR*.
  
  !     PARAMETER     DESCRIPTION                                   UNITS
  !     ---------     -----------                                   -----
  !     INPUT PARAMETERS (INTEGER):
  
  !    *KIDIA*        START POINT
  !    *KFDIA*        END POINT
  !    *KLON*         NUMBER OF GRID POINTS PER PACKET
  !    *KLEV*         NUMBER OF LEVELS
  !    *KCBOT*        CLOUD BASE LEVEL
  !    *KCTOP*        CLOUD TOP LEVEL
  !    *KDTOP*        TOP LEVEL OF DOWNDRAFTS
  
  !    INPUT PARAMETERS (LOGICAL):
  
  !    *LDLAND*       LAND SEA MASK (.TRUE. FOR LAND)
  !    *LDCUM*        FLAG: .TRUE. FOR CONVECTIVE POINTS
  !    *LDTDKMF*      Arpege tuning (if TRUE)
  
  !    INPUT PARAMETERS (REAL):
  
  !    *PTSPHY*       TIME STEP FOR THE PHYSICS                       S
  !    *PTEN*         PROVISIONAL ENVIRONMENT TEMPERATURE (T+1)       K
  !    *PQEN*         PROVISIONAL ENVIRONMENT SPEC. HUMIDITY (T+1)  KG/KG
  !    *PQSEN*        ENVIRONMENT SPEC. SATURATION HUMIDITY (T+1)   KG/KG
  !    *PTENH*        ENV. TEMPERATURE (T+1) ON HALF LEVELS           K
  !    *PQENH*        ENV. SPEC. HUMIDITY (T+1) ON HALF LEVELS      KG/KG
  !    *PAPH*         PROVISIONAL PRESSURE ON HALF LEVELS            PA
  !    *PAP*          PROVISIONAL PRESSURE ON FULL LEVELS            PA
  !    *PGEOH*        GEOPOTENTIAL ON HALF LEVELS                   M2/S2
  
  !    UPDATED PARAMETERS (INTEGER):
  
  !    *KTYPE*        SET TO ZERO IF LDCUM=.FALSE.
  
  !    UPDATED PARAMETERS (LOGICAL):
  
  !    *LDDRAF*       SET TO .FALSE. IF LDCUM=.FALSE. OR KDTOP<KCTOP
  
  !    UPDATED PARAMETERS (REAL):
  
  !    *PMFU*         MASSFLUX IN UPDRAFTS                          KG/(M2*S)
  !    *PMFD*         MASSFLUX IN DOWNDRAFTS                        KG/(M2*S)
  !    *PMFUS*        FLUX OF DRY STATIC ENERGY IN UPDRAFTS          J/(M2*S)
  !    *PMFDS*        FLUX OF DRY STATIC ENERGY IN DOWNDRAFTS        J/(M2*S)
  !    *PMFUQ*        FLUX OF SPEC. HUMIDITY IN UPDRAFTS            KG/(M2*S)
  !    *PMFDQ*        FLUX OF SPEC. HUMIDITY IN DOWNDRAFTS          KG/(M2*S)
  !    *PMFUL*        FLUX OF LIQUID WATER IN UPDRAFTS              KG/(M2*S)
  !    *PLUDE*        DETRAINED LIQUID WATER                        KG/(M2*S)
  !    *PLRAIN*       SNOW/RAIN MIXING RATIO                        KG/(KG)
  !    *PSNDE*        DETRAINED SNOW/RAIN                           KG/(M2*S)
  !    *PDMFUP*       FLUX DIFFERENCE OF PRECIP. IN UPDRAFTS        KG/(M2*S)
  !    *PDMFDP*       FLUX DIFFERENCE OF PRECIP. IN DOWNDRAFTS      KG/(M2*S)
  !    *PMFUDE_RATE*  UPDRAFT DETRAINMENT RATE                      KG/(M2*S)
  !    *PMFDDE_RATE*  DOWNDRAFT DETRAINMENT RATE                    KG/(M2*S)
  
  !    OUTPUT PARAMETERS (REAL):
  
  !    *PDPMEL*       CHANGE IN PRECIP.-FLUXES DUE TO MELTING       KG/(M2*S)
  !    *PLGLAC*       FLUX OF FROZEN CLOUD WATER IN UPDRAFTS        KG/(M2*S)
  !    *PMFLXR*       CONVECTIVE RAIN FLUX                          KG/(M2*S)
  !    *PMFLXS*       CONVECTIVE SNOW FLUX                          KG/(M2*S)
  !    *PRAIN*        TOTAL PRECIP. PRODUCED IN CONV. UPDRAFTS      KG/(M2*S)
  !                   (NO EVAPORATION IN DOWNDRAFTS)
  
  !          EXTERNALS
  !          ---------
  !          NONE
  
  !     AUTHOR.
  !     -------
  !      M.TIEDTKE         E.C.M.W.F.     7/86 MODIF. 12/89
  
  !     MODIFICATIONS.
  !     --------------
  !      03-08-28 : Clean up LINPHYS; Bugs in Evapor.    P.BECHTOLD
  !      05-02-11 : Extend DDMflux to surface if zero    P.BECHTOLD
  !      M.Hamrud      01-Oct-2003 CY28 Cleaning
  !      N.Semane+P.Bechtold     04-10-2012 Add RCVRFACTOR factor for small planet
  !      20210913 : Modifications for Arpege Y.Bouteloup (LDTDKMF)
  !     R. El Khatib 22-Jun-2022 A contribution to simplify phasing after the refactoring of YOMCLI/YOMCST/YOETHF.
  !----------------------------------------------------------------------
  
!$acc routine( CUFLXN_OPENACC ) seq
  
  USE PARKIND1, ONLY: JPIM, JPRB
  USE YOMHOOK, ONLY: LHOOK, DR_HOOK, JPHOOK
  
  USE YOMCST, ONLY: TCST
  USE YOETHF, ONLY: TTHF
  USE YOEPHLI, ONLY: TEPHLI
  USE YOECUMF, ONLY: TECUMF
  
  USE STACK_MOD
#include "stack.h"
  
  IMPLICIT NONE
  
  TYPE(TTHF), INTENT(IN) :: YDTHF
  TYPE(TCST), INTENT(IN) :: YDCST
  TYPE(TECUMF), INTENT(IN) :: YDECUMF
  TYPE(TEPHLI), INTENT(IN) :: YDEPHLI
  INTEGER(KIND=JPIM), INTENT(IN) :: KLON
  INTEGER(KIND=JPIM), INTENT(IN) :: KLEV
  INTEGER(KIND=JPIM), INTENT(IN) :: KIDIA
  INTEGER(KIND=JPIM), INTENT(IN) :: KFDIA
  REAL(KIND=JPRB), INTENT(IN) :: PTSPHY
  REAL(KIND=JPRB), INTENT(IN) :: PTEN(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PQEN(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PQSEN(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PTENH(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PQENH(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PAPH(KLON, KLEV + 1)
  REAL(KIND=JPRB), INTENT(IN) :: PAP(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(IN) :: PGEOH(KLON, KLEV + 1)
  LOGICAL, INTENT(IN) :: LDLAND(KLON)
  LOGICAL, INTENT(IN) :: LDCUM(KLON)
  LOGICAL, INTENT(IN) :: LDTDKMF
  INTEGER(KIND=JPIM), INTENT(IN) :: KCBOT(KLON)
  INTEGER(KIND=JPIM), INTENT(IN) :: KCTOP(KLON)
  INTEGER(KIND=JPIM), INTENT(IN) :: KDTOP(KLON)
  INTEGER(KIND=JPIM), INTENT(OUT) :: KTOPM2
  INTEGER(KIND=JPIM), INTENT(INOUT) :: KTYPE(KLON)
  LOGICAL, INTENT(INOUT) :: LDDRAF(KLON)
  REAL(KIND=JPRB), INTENT(INOUT) :: PMFU(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PMFD(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PMFUS(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PMFDS(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PMFUQ(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PMFDQ(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PMFUL(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(OUT) :: PLUDE(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(OUT) :: PLUDELI(KLON, KLEV, 2)
  REAL(KIND=JPRB), INTENT(IN) :: PLRAIN(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(OUT) :: PSNDE(KLON, KLEV, 2)
  REAL(KIND=JPRB), INTENT(INOUT) :: PDMFUP(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PDMFDP(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(OUT) :: PDPMEL(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PLGLAC(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(OUT) :: PMFLXR(KLON, KLEV + 1)
  REAL(KIND=JPRB), INTENT(OUT) :: PMFLXS(KLON, KLEV + 1)
  REAL(KIND=JPRB), INTENT(OUT) :: PRAIN(KLON)
  REAL(KIND=JPRB), INTENT(IN) :: PMFUDE_RATE(KLON, KLEV)
  REAL(KIND=JPRB), INTENT(INOUT) :: PMFDDE_RATE(KLON, KLEV)
  
  REAL(KIND=JPRB) :: ZRHEBC
  REAL(KIND=JPRB) :: ZMFS
  REAL(KIND=JPRB) :: ZRCUCOV
  INTEGER(KIND=JPIM) :: IK
  INTEGER(KIND=JPIM) :: IKB
  INTEGER(KIND=JPIM) :: JK
  INTEGER(KIND=JPIM) :: JL
  INTEGER(KIND=JPIM) :: IDBAS
  LOGICAL :: LLDDRAF
  
  REAL(KIND=JPRB) :: ZALFAW
  REAL(KIND=JPRB) :: ZCONS1
  REAL(KIND=JPRB) :: ZCONS1A
  REAL(KIND=JPRB) :: ZCONS2
  REAL(KIND=JPRB) :: ZDENOM
  REAL(KIND=JPRB) :: ZDRFL
  REAL(KIND=JPRB) :: ZDRFL1
  REAL(KIND=JPRB) :: ZFAC
  REAL(KIND=JPRB) :: ZFOEEWI
  REAL(KIND=JPRB) :: ZFOEEWL
  REAL(KIND=JPRB) :: ZOEALFA
  REAL(KIND=JPRB) :: ZOEEWM
  REAL(KIND=JPRB) :: ZOELHM
  REAL(KIND=JPRB) :: ZPDR
  REAL(KIND=JPRB) :: ZPDS
  REAL(KIND=JPRB) :: ZRFL
  REAL(KIND=JPRB) :: ZRFLN
  REAL(KIND=JPRB) :: ZRMIN
  REAL(KIND=JPRB) :: ZRNEW
  REAL(KIND=JPRB) :: ZSNMLT
  REAL(KIND=JPRB) :: ZTARG
  REAL(KIND=JPRB) :: ZTMST
  REAL(KIND=JPRB) :: ZZP
  REAL(KIND=JPRB) :: ZTWETB
  REAL(KIND=JPRB) :: ZWETB
  REAL(KIND=JPRB) :: ZTEN
  REAL(KIND=JPRB) :: ZGLAC
  REAL(KIND=JPRB) :: ZMFMAX
  REAL(KIND=JPRB) :: ZRHM
  ! Numerical fit to wet bulb temperature
  REAL(KIND=JPRB), PARAMETER :: ZTW1 = 1329.31_JPRB
  REAL(KIND=JPRB), PARAMETER :: ZTW2 = 0.0074615_JPRB
  REAL(KIND=JPRB), PARAMETER :: ZTW3 = 0.85E5_JPRB
  REAL(KIND=JPRB), PARAMETER :: ZTW4 = 40.637_JPRB
  REAL(KIND=JPRB), PARAMETER :: ZTW5 = 275.0_JPRB
  REAL(KIND=JPHOOK) :: ZHOOK_HANDLE
  
  !DIR$ VFUNCTION EXPHF
#include "fcttre.func.h"
  INTEGER(KIND=    JPIM) :: JLON
  TYPE(STACK), INTENT(IN) :: YDSTACK
  TYPE(STACK) :: YLSTACK
  YLSTACK = YDSTACK
  JLON = KIDIA
  
  !--------------------------------------------------------------------
  !*             SPECIFY CONSTANTS
  
  ZTMST = PTSPHY
  ZCONS1A = YDCST%RCPD / (YDCST%RLMLT*YDCST%RG*YDECUMF%RTAUMEL)
  !ZCONS2=1.0_JPRB/(RG*ZTMST)
  ZCONS2 = YDECUMF%RMFCFL / (YDCST%RG*ZTMST)
  IF (YDECUMF%LMFWETB) THEN
    ZWETB = 1.0_JPRB
  ELSE
    ZWETB = 0.0_JPRB
  END IF
  IF (YDECUMF%LMFGLAC) THEN
    ZGLAC = 0.0_JPRB
  ELSE
    ZGLAC = 1.0_JPRB
  END IF
  
  !*    1.0          DETERMINE FINAL CONVECTIVE FLUXES
  !                  ---------------------------------
  
  PRAIN(JLON) = 0.0_JPRB
  IF (.not.LDCUM(JLON) .or. KDTOP(JLON) < KCTOP(JLON)) LDDRAF(JLON) = .false.
  IF (.not.LDCUM(JLON)) KTYPE(JLON) = 0
  IDBAS = KLEV
  IF (LDLAND(JLON)) THEN
    ZRHEBC = 0.75_JPRB
    IF (KTYPE(JLON) == 1) ZRHEBC = 0.70_JPRB
  ELSE
    ZRHEBC = YDECUMF%RHEBC
    IF (KTYPE(JLON) == 1) ZRHEBC = 0.85_JPRB
  END IF
  ! TO GET IDENTICAL RESULTS FOR DIFFERENT NPROMA FORCE KTOPM2 TO 2
  KTOPM2 = 2
  DO JK=KTOPM2,KLEV
    IKB = MIN(JK + 1, KLEV)
    !DIR$ IVDEP
    !OCL NOVREC
    PMFLXR(JLON, JK) = 0.0_JPRB
    PMFLXS(JLON, JK) = 0.0_JPRB
    PDPMEL(JLON, JK) = 0.0_JPRB
    PSNDE(JLON, JK, 1) = 0.0_JPRB
    PSNDE(JLON, JK, 2) = 0.0_JPRB
    IF (LDCUM(JLON) .and. JK >= KCTOP(JLON)) THEN
      PMFUS(JLON, JK) = PMFUS(JLON, JK) - PMFU(JLON, JK)*(YDCST%RCPD*PTENH(JLON, JK) + PGEOH(JLON, JK))
      PMFUQ(JLON, JK) = PMFUQ(JLON, JK) - PMFU(JLON, JK)*PQENH(JLON, JK)
      PLGLAC(JLON, JK) = PMFU(JLON, JK)*PLGLAC(JLON, JK)
      LLDDRAF = LDDRAF(JLON) .and. JK >= KDTOP(JLON)
      IF (LLDDRAF) THEN
        PMFDS(JLON, JK) = PMFDS(JLON, JK) - PMFD(JLON, JK)*(YDCST%RCPD*PTENH(JLON, JK) + PGEOH(JLON, JK))
        PMFDQ(JLON, JK) = PMFDQ(JLON, JK) - PMFD(JLON, JK)*PQENH(JLON, JK)
      ELSE
        PMFD(JLON, JK) = 0.0_JPRB
        PMFDS(JLON, JK) = 0.0_JPRB
        PMFDQ(JLON, JK) = 0.0_JPRB
        PDMFDP(JLON, JK - 1) = 0.0_JPRB
      END IF
      IF (LLDDRAF .and. PMFD(JLON, JK) < 0._JPRB .and. PMFD(JLON, IKB) == 0._JPRB) THEN
        IDBAS = JK
      END IF
    ELSE
      PMFU(JLON, JK) = 0.0_JPRB
      PMFD(JLON, JK) = 0.0_JPRB
      PMFUS(JLON, JK) = 0.0_JPRB
      PMFDS(JLON, JK) = 0.0_JPRB
      PMFUQ(JLON, JK) = 0.0_JPRB
      PMFDQ(JLON, JK) = 0.0_JPRB
      PMFUL(JLON, JK) = 0.0_JPRB
      PLGLAC(JLON, JK) = 0.0_JPRB
      PDMFUP(JLON, JK - 1) = 0.0_JPRB
      PDMFDP(JLON, JK - 1) = 0.0_JPRB
      PLUDE(JLON, JK - 1) = 0.0_JPRB
      PLUDELI(JLON, JK - 1, 1) = 0.0_JPRB
      PLUDELI(JLON, JK - 1, 2) = 0.0_JPRB
    END IF
  END DO
  PMFLXR(JLON, KLEV + 1) = 0.0_JPRB
  PMFLXS(JLON, KLEV + 1) = 0.0_JPRB
  PMFLXR(JLON, 1) = 0.0_JPRB
  PMFLXS(JLON, 1) = 0.0_JPRB
  PSNDE(JLON, 1, 1) = 0.0_JPRB
  PSNDE(JLON, 1, 2) = 0.0_JPRB
  
  !*    1.5          SCALE FLUXES BELOW CLOUD BASE
  !                  LINEAR DCREASE
  !                  -----------------------------
  
  !DIR$ IVDEP
  !OCL NOVREC
  IF (LDCUM(JLON)) THEN
    IKB = KCBOT(JLON)
    IK = IKB + 1
    ZZP = ((PAPH(JLON, KLEV + 1) - PAPH(JLON, IK)) / (PAPH(JLON, KLEV + 1) - PAPH(JLON, IKB)))
    IF (KTYPE(JLON) == 3) ZZP = ZZP*ZZP
    PMFU(JLON, IK) = PMFU(JLON, IKB)*ZZP
    IF (YDEPHLI%LPHYLIN) THEN
      ZTARG = PTENH(JLON, IKB)
      ZOEALFA = MIN(1.0_JPRB, 0.545_JPRB*(TANH(0.17_JPRB*(ZTARG - YDEPHLI%RLPTRC)) + 1.0_JPRB))
      ZOELHM = ZOEALFA*YDCST%RLVTT + (1.0_JPRB - ZOEALFA)*YDCST%RLSTT
      PMFUS(JLON, IK) = (PMFUS(JLON, IKB) - ZOELHM*PMFUL(JLON, IKB))*ZZP
    ELSE
      PMFUS(JLON, IK) = (PMFUS(JLON, IKB) - FOELHMCU(PTENH(JLON, IKB))*PMFUL(JLON, IKB))*ZZP
    END IF
    PMFUQ(JLON, IK) = (PMFUQ(JLON, IKB) + PMFUL(JLON, IKB))*ZZP
    PMFUL(JLON, IK) = 0.0_JPRB
  END IF
  DO JK=KTOPM2,KLEV
    !DIR$ IVDEP
    !OCL NOVREC
    IF (LDCUM(JLON) .and. JK > KCBOT(JLON) + 1) THEN
      IKB = KCBOT(JLON) + 1
      ZZP = ((PAPH(JLON, KLEV + 1) - PAPH(JLON, JK)) / (PAPH(JLON, KLEV + 1) - PAPH(JLON, IKB)))
      IF (KTYPE(JLON) == 3) ZZP = ZZP*ZZP
      PMFU(JLON, JK) = PMFU(JLON, IKB)*ZZP
      PMFUS(JLON, JK) = PMFUS(JLON, IKB)*ZZP
      PMFUQ(JLON, JK) = PMFUQ(JLON, IKB)*ZZP
      PMFUL(JLON, JK) = 0.0_JPRB
    END IF
    IK = IDBAS
    LLDDRAF = LDDRAF(JLON) .and. JK > IK .and. IK < KLEV
    IF (LLDDRAF .and. IK == KCBOT(JLON) + 1) THEN
      ZZP = ((PAPH(JLON, KLEV + 1) - PAPH(JLON, JK)) / (PAPH(JLON, KLEV + 1) - PAPH(JLON, IK)))
      IF (KTYPE(JLON) == 3) ZZP = ZZP*ZZP
      PMFD(JLON, JK) = PMFD(JLON, IK)*ZZP
      PMFDS(JLON, JK) = PMFDS(JLON, IK)*ZZP
      PMFDQ(JLON, JK) = PMFDQ(JLON, IK)*ZZP
      PMFDDE_RATE(JLON, JK) = -(PMFD(JLON, JK - 1) - PMFD(JLON, JK))
    ELSE IF (LLDDRAF .and. IK /= KCBOT(JLON) + 1 .and. JK == IK + 1) THEN
      PMFDDE_RATE(JLON, JK) = -(PMFD(JLON, JK - 1) - PMFD(JLON, JK))
    END IF
  END DO
  
  !- rescale DD fluxes if total mass flux becomes negative
  ZMFS = 1.0_JPRB
  !DO JK=2,KLEV-1
  DO JK=2,KLEV
    ! change for stability
    !DIR$ LOOP_INFO EST_TRIPS(16)
    IF (LDDRAF(JLON) .and. JK >= KDTOP(JLON) - 1) THEN
      ZMFMAX = ABS(PMFU(JLON, JK))*0.98_JPRB
      IF (PMFD(JLON, JK) + ZMFMAX + 1.E-15_JPRB < 0.0_JPRB) THEN
        ZMFS = MIN(ZMFS, -ZMFMAX / PMFD(JLON, JK))
      END IF
    END IF
  END DO
  
  DO JK=2,KLEV
    !DIR$ LOOP_INFO EST_TRIPS(16)
    IF (ZMFS < 1.0_JPRB .and. JK >= KDTOP(JLON) - 1) THEN
      PMFD(JLON, JK) = PMFD(JLON, JK)*ZMFS
      PMFDS(JLON, JK) = PMFDS(JLON, JK)*ZMFS
      PMFDQ(JLON, JK) = PMFDQ(JLON, JK)*ZMFS
      PMFDDE_RATE(JLON, JK) = PMFDDE_RATE(JLON, JK)*ZMFS
      PDMFDP(JLON, JK) = PDMFDP(JLON, JK)*ZMFS
    END IF
  END DO
  
  
  !*    2.            CALCULATE RAIN/SNOW FALL RATES
  !*                  CALCULATE MELTING OF SNOW
  !*                  CALCULATE EVAPORATION OF PRECIP
  !                   -------------------------------
  
  DO JK=KTOPM2,KLEV
    IF (LDCUM(JLON) .and. JK >= KCTOP(JLON) - 1) THEN
      PRAIN(JLON) = PRAIN(JLON) + PDMFUP(JLON, JK)
      ZTWETB = PTEN(JLON, JK) - MAX(0.0_JPRB, PQSEN(JLON, JK) - PQEN(JLON, JK))*(ZTW1 + ZTW2*(PAP(JLON, JK) - ZTW3) -  &
      & ZTW4*(PTEN(JLON, JK) - ZTW5))
      ZTEN = ZTWETB*ZWETB + (1.0_JPRB - ZWETB)*PTEN(JLON, JK)
      IF (PMFLXS(JLON, JK) > 0.0_JPRB .and. ZTEN > YDCST%RTT) THEN
        ZCONS1 = ZCONS1A*(1.0_JPRB + 0.5_JPRB*(ZTEN - YDCST%RTT))
        ZFAC = ZCONS1*(PAPH(JLON, JK + 1) - PAPH(JLON, JK))
        ZSNMLT = MIN(PMFLXS(JLON, JK), ZFAC*(ZTEN - YDCST%RTT))
        PDPMEL(JLON, JK) = ZSNMLT
        IF (YDEPHLI%LPHYLIN) THEN
          ZTARG = ZTEN - ZSNMLT / ZFAC
          ZOEALFA = MIN(1.0_JPRB, 0.545_JPRB*(TANH(0.17_JPRB*(ZTARG - YDEPHLI%RLPTRC)) + 1.0_JPRB))
          ZFOEEWL = YDTHF%R2ES*EXP(YDTHF%R3LES*(ZTARG - YDCST%RTT) / (ZTARG - YDTHF%R4LES))
          ZFOEEWI = YDTHF%R2ES*EXP(YDTHF%R3IES*(ZTARG - YDCST%RTT) / (ZTARG - YDTHF%R4IES))
          ZOEEWM = ZOEALFA*ZFOEEWL + (1.0_JPRB - ZOEALFA)*ZFOEEWI
          PQSEN(JLON, JK) = ZOEEWM / PAP(JLON, JK)
        ELSE
          PQSEN(JLON, JK) = FOEEWMCU(ZTEN - ZSNMLT / ZFAC) / PAP(JLON, JK)
        END IF
      END IF
      IF (YDEPHLI%LPHYLIN) THEN
        ZALFAW = MIN(1.0_JPRB, 0.545_JPRB*(TANH(0.17_JPRB*(ZTEN - YDEPHLI%RLPTRC)) + 1.0_JPRB))
      ELSE
        ZALFAW = FOEALFCU(ZTEN)
      END IF
      !no liquid precipitation above melting level
      !     add heat not yet liberated in updraught precip
      IF (PTEN(JLON, JK) <= YDCST%RTT .and. ZALFAW > 0.0_JPRB) THEN
        PLGLAC(JLON, JK) = PLGLAC(JLON, JK) + ZGLAC*ZALFAW*PDMFUP(JLON, JK) + ZALFAW*PDMFDP(JLON, JK)
        ZALFAW = 0.0_JPRB
      END IF
      IF (YDECUMF%LMFDSNOW .and. JK <= KCBOT(JLON)) THEN
        PSNDE(JLON, JK, 2) = PLRAIN(JLON, JK + 1)*PMFUDE_RATE(JLON, JK)
        PSNDE(JLON, JK, 1) = PSNDE(JLON, JK, 2)*ZALFAW
        PSNDE(JLON, JK, 2) = PSNDE(JLON, JK, 2)*(1.0_JPRB - ZALFAW)
        PSNDE(JLON, JK, 1) = MIN(PSNDE(JLON, JK, 1), ZALFAW*(PDMFUP(JLON, JK) + PDMFDP(JLON, JK)))
        PSNDE(JLON, JK, 2) =  &
        & MIN(PSNDE(JLON, JK, 2), (1.0_JPRB - ZALFAW)*(PDMFUP(JLON, JK) + PDMFDP(JLON, JK)) - PDPMEL(JLON, JK))
        !PSNDE(JL,JK,1)=0.0_JPRB
        PSNDE(JLON, JK, 1) = MAX(PSNDE(JLON, JK, 1), 0.0_JPRB)
        PSNDE(JLON, JK, 2) = MAX(PSNDE(JLON, JK, 2), 0.0_JPRB)
      END IF
      PMFLXR(JLON, JK + 1) =  &
      & PMFLXR(JLON, JK) + ZALFAW*(PDMFUP(JLON, JK) + PDMFDP(JLON, JK)) + PDPMEL(JLON, JK) - PSNDE(JLON, JK, 1)
      PMFLXS(JLON, JK + 1) =  &
      & PMFLXS(JLON, JK) + (1.0_JPRB - ZALFAW)*(PDMFUP(JLON, JK) + PDMFDP(JLON, JK)) - PDPMEL(JLON, JK) - PSNDE(JLON, JK, 2)
      IF (PMFLXR(JLON, JK + 1) + PMFLXS(JLON, JK + 1) < 0.0_JPRB) THEN
        PDMFDP(JLON, JK) = -(PMFLXR(JLON, JK) + PMFLXS(JLON, JK) + PDMFUP(JLON, JK))
        PMFLXR(JLON, JK + 1) = 0.0_JPRB
        PMFLXS(JLON, JK + 1) = 0.0_JPRB
        PDPMEL(JLON, JK) = 0.0_JPRB
      ELSE IF (PMFLXR(JLON, JK + 1) < 0.0_JPRB) THEN
        PMFLXS(JLON, JK + 1) = PMFLXS(JLON, JK + 1) + PMFLXR(JLON, JK + 1)
        PMFLXR(JLON, JK + 1) = 0.0_JPRB
      ELSE IF (PMFLXS(JLON, JK + 1) < 0.0_JPRB) THEN
        PMFLXR(JLON, JK + 1) = PMFLXR(JLON, JK + 1) + PMFLXS(JLON, JK + 1)
        PMFLXS(JLON, JK + 1) = 0.0_JPRB
      END IF
    END IF
  END DO
  
  ! Increase area fraction for evaporation depending on average RH in cloud-layer
  IF (.not.LDTDKMF) THEN
    IF (KTYPE(JLON) >= 2) THEN
      IKB = KCBOT(JLON)
      IK = KCTOP(JLON)
      ZRHM = 0.5*(PQEN(JLON, IKB) / PQSEN(JLON, IKB) + PQEN(JLON, IK) / PQSEN(JLON, IK))
      ZRCUCOV = YDECUMF%RCUCOV*(1.0_JPRB + (MAX(0.8_JPRB, ZRHM) - 0.8_JPRB) / 0.025_JPRB)
    ELSE
      ZRCUCOV = YDECUMF%RCUCOV*0.6
    END IF
  ELSE
    ZRCUCOV = YDECUMF%RCUCOV
  END IF
  
  DO JK=KTOPM2,KLEV
    IF (LDCUM(JLON) .and. JK >= KCBOT(JLON)) THEN
      ZRFL = PMFLXR(JLON, JK) + PMFLXS(JLON, JK)
      IF (ZRFL > 1.E-12_JPRB) THEN
        ZDRFL1 = YDECUMF%RCPECONS*MAX(0.0_JPRB, PQSEN(JLON, JK) - PQEN(JLON, JK))*ZRCUCOV*(SQRT(PAPH(JLON, JK) / PAPH(JLON, KLEV  &
        & + 1)) / YDECUMF%RCVRFACTOR*ZRFL / ZRCUCOV)**0.5777_JPRB*(PAPH(JLON, JK + 1) - PAPH(JLON, JK))
        ZRNEW = ZRFL - ZDRFL1
        ZRMIN =  &
        & ZRFL - ZRCUCOV*MAX(0.0_JPRB, ZRHEBC*PQSEN(JLON, JK) - PQEN(JLON, JK))*ZCONS2*(PAPH(JLON, JK + 1) - PAPH(JLON, JK))
        ZRNEW = MAX(ZRNEW, ZRMIN)
        ZRFLN = MAX(ZRNEW, 0.0_JPRB)
        ZDRFL = MIN(0.0_JPRB, ZRFLN - ZRFL)
        IF (YDEPHLI%LPHYLIN) THEN
          ZALFAW = MIN(1.0_JPRB, 0.545_JPRB*(TANH(0.17_JPRB*(PTEN(JLON, JK) - YDEPHLI%RLPTRC)) + 1.0_JPRB))
        ELSE
          ZALFAW = FOEALFCU(PTEN(JLON, JK))
        END IF
        IF (PTEN(JLON, JK) < YDCST%RTT) ZALFAW = 0.0_JPRB
        ZPDR = ZALFAW*PDMFDP(JLON, JK)
        ZPDS = (1.0_JPRB - ZALFAW)*PDMFDP(JLON, JK)
        ZDENOM = 1.0_JPRB / MAX(1.E-12_JPRB, PMFLXR(JLON, JK) + PMFLXS(JLON, JK))
        PMFLXR(JLON, JK + 1) = PMFLXR(JLON, JK) + ZPDR + PDPMEL(JLON, JK) + ZDRFL*PMFLXR(JLON, JK)*ZDENOM
        PMFLXS(JLON, JK + 1) = PMFLXS(JLON, JK) + ZPDS - PDPMEL(JLON, JK) + ZDRFL*PMFLXS(JLON, JK)*ZDENOM
        PDMFUP(JLON, JK) = PDMFUP(JLON, JK) + ZDRFL
        IF (PMFLXR(JLON, JK + 1) + PMFLXS(JLON, JK + 1) < 0.0_JPRB) THEN
          PDMFUP(JLON, JK) = PDMFUP(JLON, JK) - (PMFLXR(JLON, JK + 1) + PMFLXS(JLON, JK + 1))
          PMFLXR(JLON, JK + 1) = 0.0_JPRB
          PMFLXS(JLON, JK + 1) = 0.0_JPRB
          PDPMEL(JLON, JK) = 0.0_JPRB
        ELSE IF (PMFLXR(JLON, JK + 1) < 0.0_JPRB) THEN
          PMFLXS(JLON, JK + 1) = PMFLXS(JLON, JK + 1) + PMFLXR(JLON, JK + 1)
          PMFLXR(JLON, JK + 1) = 0.0_JPRB
        ELSE IF (PMFLXS(JLON, JK + 1) < 0.0_JPRB) THEN
          PMFLXR(JLON, JK + 1) = PMFLXR(JLON, JK + 1) + PMFLXS(JLON, JK + 1)
          PMFLXS(JLON, JK + 1) = 0.0_JPRB
        END IF
      ELSE
        PMFLXR(JLON, JK + 1) = 0.0_JPRB
        PMFLXS(JLON, JK + 1) = 0.0_JPRB
        PDMFDP(JLON, JK) = 0.0_JPRB
        PDPMEL(JLON, JK) = 0.0_JPRB
      END IF
    END IF
  END DO
  
END SUBROUTINE CUFLXN_OPENACC
