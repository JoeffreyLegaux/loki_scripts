
SUBROUTINE ACMICRO_OPENACC (YDCST, YDML_PHY_MF, KIDIA, KFDIA, KLON, KTDIA,&
& KLEV, PNEBST, PT, PQL, PQI, PTS, PNEIJ, PLSM, PAUTOL, PAUTOI, YDSTACK)
!$acc routine (ACMICRO_OPENACC) seq
USE MODEL_PHYSICS_MF_MOD,ONLY:MODEL_PHYSICS_MF_TYPE
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE STACK_MOD
#include "stack.h"

IMPLICIT NONE

TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_MF_TYPE), INTENT (IN)::YDML_PHY_MF
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
REAL (KIND=JPRB), INTENT (IN)::PNEBST (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PNEIJ (KLON)
REAL (KIND=JPRB), INTENT (IN)::PLSM (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PAUTOL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PAUTOI (KLON, KLEV)
TYPE(STACK) :: YDSTACK
TYPE(STACK) :: YLSTACK

REAL (KIND=JPRB)::ZFACICE
REAL (KIND=JPRB)::ZBETA
REAL (KIND=JPRB)::ZARG2
REAL (KIND=JPRB)::ZARG1
REAL (KIND=JPRB)::ZQCR
REAL (KIND=JPRB)::ZDUM
REAL (KIND=JPRB)::ZALPH
REAL (KIND=JPRB)::ZCAUT
REAL (KIND=JPRB)::ZQI
REAL (KIND=JPRB)::ZQL

temp (REAL (KIND=JPRB), ZEFFA, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZDELT, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZAUTOI, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZAUTOL, (KLON, KLEV))

INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JLON


YLSTACK = YDSTACK

alloc (ZEFFA)
alloc (ZDELT)
alloc (ZAUTOI)
alloc (ZAUTOL)



JLON = KIDIA


ZARG1=2.0_JPRB*YDML_PHY_MF%YRPHY0%RQICRMAX*(1.0_JPRB-0.999_JPRB)/(YDML_PHY_MF&
&%YRPHY0%RQICRMAX-YDML_PHY_MF%YRPHY0%RQICRMIN)-1.0_JPRB
ZARG2=2.0_JPRB*(YDML_PHY_MF%YRPHY0%RQICRMAX-1.5_JPRB*YDML_PHY_MF%YRPHY0%RQICRMIN&
&)/(YDML_PHY_MF%YRPHY0%RQICRMAX-YDML_PHY_MF%YRPHY0%RQICRMIN)-1.0_JPRB
ZARG1=0.5_JPRB*LOG (ABS ((1.0_JPRB+ZARG1)/(1.0_JPRB-ZARG1)))
ZARG2=0.5_JPRB*LOG (ABS ((1.0_JPRB+ZARG2)/(1.0_JPRB-ZARG2)))
ZALPH=(ZARG1-ZARG2)/(YDML_PHY_MF%YRPHY0%RQICRT2-YDML_PHY_MF%YRPHY0%RQICRT1)
ZBETA=ZARG1-YDML_PHY_MF%YRPHY0%RQICRT2*ZALPH

DO JLEV=KTDIA, KLEV
  
  ZDELT (JLON, JLEV)=PT (JLON, JLEV)-YDCST%RTT
  ZEFFA (JLON, JLEV)=EXP (YDML_PHY_MF%YRPHY0%RAUTSBET*ZDELT (JLON, JLEV))
  
ENDDO


DO JLEV=KTDIA, KLEV
  
  ZQL=MAX (0.0_JPRB, PQL (JLON, JLEV)/PNEBST (JLON, JLEV))
  ZQI=MAX (0.0_JPRB, PQI (JLON, JLEV)/PNEBST (JLON, JLEV))
  ZCAUT=YDML_PHY_MF%YRPHY0%RAUTEFR
  ZDUM=(1.0_JPRB-EXP (-ZCAUT*YDML_PHY_MF%YRPHY2%TSPHY))*(ZQL&
  &-YDML_PHY_MF%YRPHY0%RQLCR)/YDML_PHY_MF%YRPHY2%TSPHY
  ZAUTOL (JLON, JLEV)=MAX (0.0_JPRB, ZDUM)
  ZCAUT=YDML_PHY_MF%YRPHY0%RAUTEFS*ZEFFA (JLON, JLEV)
  ZQCR=YDML_PHY_MF%YRPHY0%RQICRMAX-(YDML_PHY_MF%YRPHY0%RQICRMAX-YDML_PHY_MF%YRPHY0&
  &%RQICRMIN)*0.5_JPRB*(1.0_JPRB+TANH (ZALPH*ZDELT (JLON, JLEV)+ZBETA))
  ZFACICE=PLSM (JLON)*PNEIJ (JLON)+(1.0_JPRB-PLSM (JLON))*MAX (0.0_JPRB&
  &, SIGN (1.0_JPRB, YDML_PHY_MF%YRPHY1%TMERGL-PTS (JLON)))
  ZQCR=ZQCR*(1.0_JPRB-ZFACICE*(1.0_JPRB-YDML_PHY_MF%YRPHY0%RQICRSN))
  ZDUM=(1.0_JPRB-EXP (-ZCAUT*YDML_PHY_MF%YRPHY2%TSPHY))*(ZQI-ZQCR)/YDML_PHY_MF%YRPHY2%TSPHY
  ZAUTOI (JLON, JLEV)=MAX (0.0_JPRB, ZDUM)
  PAUTOL (JLON, JLEV)=ZAUTOL (JLON, JLEV)*PNEBST (JLON, JLEV)
  PAUTOI (JLON, JLEV)=ZAUTOI (JLON, JLEV)*PNEBST (JLON, JLEV)
  
ENDDO



ENDSUBROUTINE ACMICRO_OPENACC

! 56ad6923076b622f9a4a36289517d0f4b37156a2
