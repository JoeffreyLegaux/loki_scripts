SUBROUTINE CPTEND_NEW (YDCST, YDMODEL, KLON, KIDIA, KFDIA, KFLEV, PGNORDL, PGNORDM,     PDIFCQ,      &
& PDIFCQI, PDIFCQL, PDIFCS, PDIFEXT,   PDIFTQ, PDIFTQI, PDIFTQL, PDIFTS,   PFCCQL, PFCCQN, PFCSQL,   &
& PFCSQN,   PFPLSL, PFPLSN, PFPLSG, PFPLCL, PFPLCN, PFPLCG,   PFESL, PFESN, PFESG, PFECL, PFECN,     &
& PFECG,   PFASL, PFASN, PFASG, PFACL, PFACN,   PFCQLNG, PFCQING, PFCQRNG, PFCQSNG, PFCQGNG,         &
& PFCQNG, PFRMH, PFRMQ, PFCHQ, PFRSO, PFRTH, PSTRCU, PSTRCV, PSTRDU, PSTRDV, PSTRTU, PSTRTV, PSTRMU, &
& PSTRMV,   PDIFCQLC, PDIFCQIC, PFIMCC,   PFEDQLC, PFEDQIC, PFEDQRC, PFEDQSC, PFCNEGQLC, PFCNEGQIC,  &
& PFCNEGQRC, PFCNEGQSC,   PFTKE, PFTKEI, PFEFB1, PFEFB2, PFEFB3,   PDELP, PRDELP, PAPHIF, PCP,   PU, &
& PV, PT,   PQ, PQI, PQL,   PQLCONV, PQICONV, PQRCONV, PQSCONV,   PQR, PQS, PQG,     PCPS, PTS,      &
& PFHSCL, PFHSCN, PFHSSL, PFHSSN, PFHSSG,   PFHPCL, PFHPCN, PFHPCG, PFHPSL, PFHPSN, PFHPSG,   PFHP,  &
& PFP, PFEPFP, PFCMPCQ, PFCMPSN, PFCMPSL,   PTENDU, PTENDV, PTENDU_ZDEC, PTENDV_ZDEC, PTENDH,        &
& PTENDQ, PTENDQI, PTENDQL,   PTENDQLCONV, PTENDQICONV,   PTENDQRCONV, PTENDQSCONV,   PTENDQR,       &
& PTENDQS, PTENDQG,   PTENDTKE, PTENDEFB1, PTENDEFB2, PTENDEFB3, PTENDEXT, YDDDH )
!     ------------------------------------------------------------------
!     ACTION DES PROCESSUS PHYSIQUES SUR LA QUANTITE DE MOUVEMENT ,
!     LES VARIABLES THERMODYNAMIQUES ET SUR L'EQUATION DE CONTINUITE
!     INTERFACE AVEC LES PARAMETRISATIONS PHYSIQUES  (IALPP)
!     ------------------------------------------------------------------

!     BUT
!     ---
!**** *CPTEND* CACUL DES TENDANCES PHYSIQUES SUR U, V, H, Q, QI, QL, TKE
!      SPECIFIQUE ET SUR LA TEMPERATURE.

!      VOIR DOCUMENTATION, INTERFACE PHYSICO-DYNAMIQUE.
!                            -----------------

!      POUR COMPRENDRE LA LOGIQUE DE CETTE ROUTINE, BIEN REALISER
!      QUE LA VARIABLE THERMODYNAMIQUE DE LA PHYSIQUE EST L ENTHALPIE
!                                                         -----------
!      (PLUS EXACTEMENT L ENERGIE STATIQUE HUMIDE)

!      LE TRANSPORT EVENTUEL PAR LES PLUIES EST PRIS EN COMPTE DE
!      MANIERE MIXTE :
!      - UNE PARTIE DE CE TRANSPORT EST CONTENUE DE MANIERE IMPLICITE
!        DANS LA FORMULATION EN FLUX D ENTHALPIE
!      - IL RESTE POURTANT UN TERME DE TRANSPORT D ENERGIE POTENTIELLE
!        QUI EST TRAITE ICI COMME UNE ADVECTION VERTICALE

!     ARGUMENTS D ENTREE
!     ------------------
!       KLON   : DIMENSION HORIZONTALE
!       KIDIA  : DEBUT DE LA BOUCLE HORIZONTALE
!       KFDIA  : BORNE HORIZONTALE DES CALCULS
!       KFLEV  : DIMENSION ET BORNE VERTICALE
!       PGNORDL,PGNORDM : compass.

! --- INPUT 2D (0:KLEV).
!     -----------------.
! PDIFCQ     : FLUX CONVECTIF D'HUMIDITE SPECIFIQUE (HORS COND. ET RR).
! PDIFCQI    : FLUX CONVECTIF D'EAU SOLIDE (HORS COND. ET RR).
! PDIFCQL    : FLUX CONVECTIF D'EAU LIQUIDE (HORS COND. ET RR).
! PDIFCS     : FLUX CONVECTIF D'ENTHALPIE .
! PDIFEXT    : FLUX DES EXTRA-GFL .
! PDIFTQ     : FLUX TURBULENT (ET Q NEGATIF) D'HUMIDITE SPECIFIQUE.
! PDIFTQI    : FLUX TURBULENT (ET Q NEGATIF) D'EAU GLACE.
! PDIFTQL    : FLUX TURBULENT (ET Q NEGATIF) D'EAU LIQUIDE.
! PDIFTS     : FLUX TURBULENT D'ENTHALPIE (OU D'ENERGIE STATIQUE SECHE).
! PFCCQL     : FLUX DE CONDENSATION LIE AUX RR CONVECTIVES LIQUIDES.
! PFCCQN     : FLUX DE CONDENSATION LIE AUX RR CONVECTIVES NEIGEUSES.
! PFCSQL     : FLUX DE CONDENSATION LIE AUX RR STRATIFORMES LIQUIDES.
! PFCSQN     : FLUX DE CONDENSATION LIE AUX RR STRATIFORMES NEIGEUSES.
! PFPLCL     : PRECIPITATIONS CONVECTIVES SOUS FORME LIQUIDE.
! PFPLCN     : PRECIPITATIONS CONVECTIVES SOUS FORME NEIGE.
! PFPLCG     : PRECIPITATIONS CONVECTIVES SOUS FORME GRAUPEL.
! PFPLSL     : PRECIPITATIONS STRATIFORMES SOUS FORME LIQUIDE.
! PFPLSN     : PRECIPITATIONS STRATIFORMES SOUS FORME NEIGE.
! PFPLSG     : PRECIPITATIONS STRATIFORMES SOUS FORME GRAUPEL.
! PFRMH      : FLUX MESOSPHERIQUE D'ENTHALPIE.
! PFRMQ      : FLUX MESOSPHERIQUE D'EAU.
! PFCHQ      : FLUX CHIMIQUE D'EAU.
! PFRSO      : FLUX DE RAYONNEMENT SOLAIRE.
! PFRTH      : FLUX DE RAYONNEMENT THERMIQUE.
! PSTRCU     : FLUX CONVECTIF DE QUANTITE DE MOUVEMENT "U".
! PSTRCV     : FLUX CONVECTIF DE QUANTITE DE MOUVEMENT "V".
! PSTRDU     : FLUX "GRAVITY WAVE DRAG" "U".
! PSTRDV     : FLUX "GRAVITY WAVE DRAG" "V".
! PSTRTU     : FLUX TURBULENT DE QUANTITE DE MOUVEMENT "U".
! PSTRTV     : FLUX TURBULENT DE QUANTITE DE MOUVEMENT "V".
! PSTRMU     : FLUX MESOSPHERIQUE DE QUANTITE DE MOUVEMENT "U".
! PSTRMV     : FLUX MESOSPHERIQUE DE QUANTITE DE MOUVEMENT "V".
! PDIFCQLC   : CONVECTIVE TRANSPORT FLUX OF QLC (LIQUID CONVECTIVE).
! PDIFCQIC   : CONVECTIVE TRANSPORT FLUX OF QIC (ICE CONVECTIVE).
! PFIMCC     : Q FLUX DUE TO ICING-MELTING FOLLOWING CONVECTIVE TRANSPORT OF CONVECTIVE LIQUID AND ICE WATER.
! PFEDQLC    : ENTRAINMENT-DETRAINMENT OF QLC AND QLR (LIQUID CONVECTIVE AND RESOLVED).
! PFEDQIC    : ENTRAINMENT-DETRAINMENT OF QIC AND QIR (ICE    CONVECTIVE AND RESOLVED).
! PFEDQRC    : ENTRAINMENT-DETRAINMENT OF QRC AND QRR (RAIN   CONVECTIVE AND RESOLVED).
! PFEDQSC    : ENTRAINMENT-DETRAINMENT OF QSC AND QSR (SNOW   CONVECTIVE AND RESOLVED).
! PFCNEGQLC  : CORRECT NEGATIVE VALUES OF QLC (LIQUID CONVECTIVE).
! PFCNEGQIC  : CORRECT NEGATIVE VALUES OF QIC (ICE    CONVECTIVE).
! PFCNEGQRC  : CORRECT NEGATIVE VALUES OF QRC (RAIN   CONVECTIVE).
! PFCNEGQSC  : CORRECT NEGATIVE VALUES OF QSC (SNOW   CONVECTIVE).
! PFTKE      : FLUX DE "TKE".

! --- INPUT 2D (1:KLEV).
!     -----------------.
! PRDELP     : INVERSE DE L'EPAISSEUR EN PRESSION DE LA COUCHE.
! PAPHIF     : GEOPOTENTIEL AUX NIVEAUX DES COUCHES.
! PCP        : CHALEUR MASSIQUE A PRESSION CONSTANTE DE L'AIR.
! PU         : COMPOSANTE EN X DU VENT.
! PV         : COMPOSANTE EN Y DU VENT.
! PT         : TEMPERATURE.
! PQ         : HUMIDITE SPECIFIQUE DE LA VAPEUR D'EAU.
! PQI        : GLACE.
! PQL        : EAU LIQUIDE.
! PQR        : RAIN
! PQS        : SNOW
! PQG        : GRAUPEL
! PQLCONV    : LIQUID WATER (CONVECTIVE).
! PQICONV    : ICE    WATER (CONVECTIVE).
! PQRCONV    : RAIN   WATER (CONVECTIVE).
! PQSCONV    : SNOW   WATER (CONVECTIVE).

! - 1D.
!   --.
! PCPS       : CHALEUR SPECIFIQUE EN SURFACE.
! PTS        : TEMPERATURE DE SURFACE.

! --- ARGUMENTS IMPLICITES.
!     --------------------.
! CONSTANTES UNIVERSELLES = COMMON /YOMCST/: RG,RCPD
! INDICATEURS LOGIQUES    = COMMON /YOMPHY/: NDPSFI,LCONDWT

! --- SORTIES 2D (0:KFLEV).
!     --------------------.
! PFHSCL : FLUX DE CHALEUR SENSIBLE LIE AUX RR CONVECTIVES LIQUIDES.
! PFHSCN : FLUX DE CHALEUR SENSIBLE LIE AUX RR CONVECTIVES NEIGEUSES.
! PFHSSL : FLUX DE CHALEUR SENSIBLE LIE AUX RR STRATIFORMES LIQUIDES.
! PFHSSN : FLUX DE CHALEUR SENSIBLE LIE AUX RR STRATIFORMES NEIGEUSES.
! PFHSSG : FLUX DE CHALEUR SENSIBLE LIE AUX RR STRATIFORMES GRAUPEL.
! PFHPCL : FLUX D'ENTHALPIE LIE A LA CONDENSATION CONVECTIVE LIQUIDE.
! PFHPCN : FLUX D'ENTHALPIE LIE A LA CONDENSATION CONVECTIVE NEIGEUSE.
! PFHPCG : FLUX D'ENTHALPIE LIE A LA CONDENSATION CONVECTIVE GRAUPEL.
! PFHPSL : FLUX D'ENTHALPIE LIE A LA CONDENSATION STRATIFORME LIQUIDE.
! PFHPSN : FLUX D'ENTHALPIE LIE A LA CONDENSATION STRATIFORME NEIGEUSE.
! PFHPSG : FLUX D'ENTHALPIE LIE A LA CONDENSATION STRATIFORME GRAUPEL.
! PFHP   : FLUX TOTAL D'ENTHALPIE + FLUX DE CHALEUR SENSIBLE.
! PFP    : FLUX TOTAL DE PRECIPITATIONS.
! PFEPFP : PSEUDO FLUX D'ENTHALPIE LIE A L'ENERGIE PRECIPITATIONS.

! --- SORTIES 2D (1:KFLEV).
!     --------------------.
! PTENDU     : TENDANCE DU VENT SUR U.
! PTENDV     : TENDANCE DU VENT SUR V.
! PTENDU_ZDEC : TENDANCE DU VENT SUR U. USED IN CPUTQY TO COMPUTE T TENDENCIES (WITHOUT DEEP CONVECTION CONTRIBUTION)
! OF LCVTDK TO AVOID DOUBLE COUNTING)
! PTENDV_ZDEC : TENDANCE DU VENT SUR V. USED IN CPUTQY TO COMPUTE T TENDENCIES (WITHOUT DEEP CONVECTION CONTRIBUTION) 
! OF LCVTDK TO AVOID DOUBLE COUNTING)
! PTENDH     : TENDANCE DE L'ENTHALPIE.
! PTENDQ     : TENDANCE DE L'HUMIDITE.
! PTENDQI    : TENDANCE DE L'EAU GLACE.
! PTENDQL    : TENDANCE DE L'EAU LIQUIDE.
! PTENDQR    : TENDANCE DU CONTENU EN EAU PRECIPITANT LIQUIDE.
! PTENDQS    : TENDANCE DU CONTENU EN EAU PRECIPITANT SOLIDE.
! PTENDQG    : TENDANCE DU CONTENU EN EAU PRECIPITANT GRAUPEL.
! PTENDQLCONV: TENDANCE DE L'EAU LIQUIDE (CONVECTIVE).
! PTENDQICONV: TENDANCE DE L'EAU GLACE   (CONVECTIVE).
! PTENDQRCONV: TENDANCE DE L'EAU PLUIE   (CONVECTIVE).
! PTENDQSCONV: TENDANCE DE L'EAU NEIGE   (CONVECTIVE).
! PTENDTKE   : TENDANCE DE TKE.
! PTENDEXT   : GFL EXTRA tendency.
! --- AUTEUR.
!     ------.
!     02/01/92 E.BAZILE.
!        Reunification de Cpaty,Cpdthp,Cpdup par E.Bazile.

! --- MODIFICATIONS.
!     --------------
!      Modified 04-01-16 by P. Marquet (Lopez and Gueremy schemes,
!                        they both add PFPEVPP to PTENDQ, with
!                        PFPFP and PFADVP only for Lopez)
!                        The signs of the fluxes PFPEVPP, PFPFP and
!                        PFADVP have changed in ADVPRC.
!      Modified 07-02-01 by M.Janousek (Catry's modifications for
!                        NDPSFI=1; tendency of pTKE)
!      Modified 07-05-07 by F.Bouyssel (tendency of TKE + Cleaning)
!      Modified 07-06-13 by T.Kovacic, PFCMPCQ, PFCMPSN, PFCMPSL added for DDH
!        Modified 11-02-01 by M. Mokhtari add the key LMDUST and traitement of passifs scalars
!        Modified 11-03-31 by M. Deque : Relax. of Meso. Specific Humidity added (fix)
!        Modified 11-12-01 by J. Van den Bergh: introduction of graupel
!        2011-09-07 J.M. Piriou: PCMT convection scheme.
!        2013-11, D. Degrauwe: Bugfix (use halflevel cp in case of NDPSFI=1).
!        2014-02-20 J.M. Piriou: fix 2 bugs in ZFHIMCC computation.
!        2014-04-30 J.M. Piriou: change sign in ZFHIMCC computation.
!        2016-10-04 P. Marguinaud : Port to single precision
!        2019-12-12 Y. Bouteloup : Introduction of PTENDU_ZDEC and PTENDV_ZDEC (for Tiedtke scheme)
!     R. El Khatib 22-Jun-2022 A contribution to simplify phasing after the refactoring of YOMCLI/YOMCST/YOETHF.
!        2023-09 M. Michou: add PFCHQ water vapor flux due to chemistry 
!-----------------------------------------------------------------------

USE TYPE_MODEL, ONLY : MODEL
USE PARKIND1  , ONLY : JPIM, JPRB, JPRD
USE YOMHOOK   , ONLY : DR_HOOK, JPHOOK, LHOOK

USE DDH_MIX   , ONLY : ADD_FIELD_3D, NEW_ADD_FIELD_3D, TYP_DDH
USE YOMLSFORC , ONLY : LMUSCLFA, NMUSCLFA
USE YOMCST    , ONLY : TCST

!-----------------------------------------------------------------------

IMPLICIT NONE

TYPE(TCST)         ,INTENT(IN)     :: YDCST
TYPE(MODEL)        ,INTENT(IN)     :: YDMODEL
INTEGER(KIND=JPIM) ,INTENT(IN)     :: KLON
INTEGER(KIND=JPIM) ,INTENT(IN)     :: KIDIA
INTEGER(KIND=JPIM) ,INTENT(IN)     :: KFDIA
INTEGER(KIND=JPIM) ,INTENT(IN)     :: KFLEV
REAL(KIND=JPRB)    ,INTENT(IN)     :: PGNORDL(KLON)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PGNORDM(KLON)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDIFCQ(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDIFCQI(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDIFCQL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDIFCS(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDIFEXT(KLON,0:KFLEV,1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDIFTQ(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDIFTQI(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDIFTQL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDIFTS(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCCQL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCCQN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCSQL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCSQN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFPLSL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFPLSN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFPLSG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFPLCL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFPLCN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFPLCG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFESL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFESN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFESG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFECL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFECN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFECG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFASL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFASN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFASG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFACL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFACN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCQLNG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCQING(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCQRNG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCQSNG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCQGNG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCQNG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFRMH(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFRMQ(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCHQ(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFRSO(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFRTH(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PSTRCU(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PSTRCV(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PSTRDU(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PSTRDV(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PSTRTU(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PSTRTV(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PSTRMU(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PSTRMV(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDIFCQLC(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDIFCQIC(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFIMCC(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFEDQLC(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFEDQIC(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFEDQRC(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFEDQSC(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCNEGQLC(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCNEGQIC(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCNEGQRC(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFCNEGQSC(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFTKE(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFTKEI(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFEFB1(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFEFB2(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PFEFB3(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PDELP(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PRDELP(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PAPHIF(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PCP(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PU(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PV(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PT(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PQ(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PQI(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PQL(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PQLCONV(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PQICONV(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PQRCONV(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PQSCONV(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PQR(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PQS(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PQG(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PCPS(KLON)
REAL(KIND=JPRB)    ,INTENT(IN)     :: PTS(KLON)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHSCL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHSCN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHSSL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHSSN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHSSG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHPCL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHPCN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHPCG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHPSL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHPSN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHPSG(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFHP(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFP(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFEPFP(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFCMPCQ(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFCMPSN(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PFCMPSL(KLON,0:KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDU(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDV(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDU_ZDEC(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDV_ZDEC(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDH(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDQ(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDQI(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDQL(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDQLCONV(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDQICONV(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDQRCONV(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDQSCONV(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDQR(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDQS(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDQG(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDTKE(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDEFB1(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDEFB2(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDEFB3(KLON,KFLEV)
REAL(KIND=JPRB)    ,INTENT(OUT)    :: PTENDEXT(KLON,KFLEV,YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
TYPE(TYP_DDH)      ,INTENT(INOUT)  :: YDDDH
!-----------------------------------------------------------------------

REAL(KIND=JPRB) :: ZGSDP (KLON,KFLEV)
REAL(KIND=JPRB) :: ZJTOT (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFHSENS(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFHDPSFI(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZTI   (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZQH   (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZQLH  (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZQIH  (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZQRH  (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZQSH  (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZQGH  (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZCHAT (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZLIFT (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFPL  (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFPN  (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFPG  (KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLSL(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLSN(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLSG(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLCL(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLCN(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLCG(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZFHIMCC(KLON,0:KFLEV)

REAL(KIND=JPRB) :: ZTMPVAR(KLON,KFLEV)
REAL(KIND=JPRB) :: ZTMPFLUX(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZSTTUG(KLON,0:KFLEV), ZSTTVG(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZSTCUG(KLON,0:KFLEV), ZSTCVG(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZSTDUG(KLON,0:KFLEV), ZSTDVG(KLON,0:KFLEV)
REAL(KIND=JPRB) :: ZTNDKKC(KLON,KFLEV), ZTNDKKD(KLON,KFLEV)
REAL(KIND=JPRB) :: ZTNDKKT(KLON,KFLEV), ZKENE(KLON,KFLEV)
REAL(KIND=JPRB) :: ZUZGEO(KLON,KFLEV), ZVMGEO(KLON,KFLEV)
REAL(KIND=JPRB) :: ZQ1(KLON,KFLEV), ZQ2(KLON,KFLEV)
REAL(KIND=JPRB) :: ZCPH

INTEGER(KIND=JPIM) :: JLEV, JLON, JGFL

LOGICAL :: LLDPSFI

REAL(KIND=JPHOOK) :: ZHOOK_HANDLE

#include "wrscmr.intfb.h"
#include "fcttrm.func.h"

!-----------------------------------------------------------------------
IF (LHOOK) CALL DR_HOOK('CPTEND_NEW',0,ZHOOK_HANDLE)

ASSOCIATE(YDPHY=>YDMODEL%YRML_PHY_MF%YRPHY,YGFL=>YDMODEL%YRML_GCONF%YGFL,YDLDDH=>YDMODEL%YRML_DIAG%YRLDDH, &
 & YDARPHY=>YDMODEL%YRML_PHY_MF%YRARPHY)
ASSOCIATE(LMDUST=>YDARPHY%LMDUST, &
 & NGFL_EXT=>YGFL%NGFL_EXT, &
 & RCPD=>YDCST%RCPD, RCPV=>YDCST%RCPV, RCS=>YDCST%RCS, RCW=>YDCST%RCW, RG=>YDCST%RG, &
 & RLSZER=>YDCST%RLSZER, RLVZER=>YDCST%RLVZER, RTT=>YDCST%RTT, &
 & LCONDWT=>YDPHY%LCONDWT, LPHSPSH=>YDPHY%LPHSPSH, LEFB=>YDPHY%LEFB, &
 & LGPCMT=>YDPHY%LGPCMT, LECT=>YDPHY%LECT, LCVTDK=>YDPHY%LCVTDK, NDPSFI=>YDPHY%NDPSFI, &
 & LGRAPRO=>YDPHY%LGRAPRO, LFLEXDIA=>YDLDDH%LFLEXDIA,LDDH_OMP=>YDLDDH%LDDH_OMP)
!-----------------------------------------------------------------------

! ------------------------------------------------------------------
! intermediate CPTEND version made for acpluie_prog and Luc's scheme
! ------------------------------------------------------------------

! the following assumptions are made:

! * Lopez scheme uses both QR and QS as prognostic variable
! * the diffusive fluxes (for qv, qi, ql and s) have a turbulent
!   and convective component
! * the pseudo-fluxes between the species (','',''') all have a
!   stratiform component, only condensation has a convective
!   component
! * CPFHPFS is integrated in this routine and should not be called
! ------------------------------------------------------------------

!    -------------------------------------------------------------------

LLDPSFI=(NDPSFI==1)
ZLIFT=0.0_JPRB
ZCHAT=0.0_JPRB

IF(LGPCMT) THEN
  ! Heat flux due to convective icing/melting of cloud condensates.
  DO JLON = KIDIA, KFDIA
    ZFHIMCC(JLON,0)=0._JPRB
  ENDDO
  DO JLEV= 1, KFLEV
    DO JLON = KIDIA, KFDIA
      ZFHIMCC(JLON,JLEV)=ZFHIMCC(JLON,JLEV-1)+(PFIMCC(JLON,JLEV)-PFIMCC(JLON,JLEV-1))&
        & *(RLVZER-RLSZER)
    ENDDO
  ENDDO
ELSE
  ZFHIMCC(:,:)=0._JPRB
ENDIF

!  ------------------------------------------------------------
!   1. CALCUL DE L'EVOLUTION DE Q ET CALCUL PARTIEL DE dU/dT ET
!  ET DE dH/dt ( avec H = CpT + Phi + Ec )
!  ------------------------------------------------------------

! Calculation of temperatures on half levels

IF (LPHSPSH) THEN
  DO JLON = KIDIA, KFDIA
    ZTI(JLON,0)=PT(JLON,1)
    ZTI(JLON,KFLEV)=PT(JLON,KFLEV)
  ENDDO
ELSE
  DO JLON = KIDIA, KFDIA
    ZTI(JLON,0)=PT(JLON,1)
    ZTI(JLON,KFLEV)=PTS(JLON)
  ENDDO
ENDIF

DO JLEV= 1, KFLEV-1
  DO JLON = KIDIA, KFDIA
    ZTI(JLON,JLEV)=(PT(JLON,JLEV)+PT(JLON,JLEV+1))*0.5_JPRB
  ENDDO
ENDDO

! preparation for case delta_m=1

IF (LLDPSFI) THEN
  DO JLON = KIDIA, KFDIA
    ZQH  (JLON,0) = 0.0_JPRB
    ZQLH (JLON,0) = 0.0_JPRB
    ZQIH (JLON,0) = 0.0_JPRB
    ZQRH (JLON,0) = 0.0_JPRB
    ZQSH (JLON,0) = 0.0_JPRB
    ZQH  (JLON,KFLEV) = PQ (JLON,KFLEV)
    ZQLH (JLON,KFLEV) = PQL(JLON,KFLEV)
    ZQIH (JLON,KFLEV) = PQI(JLON,KFLEV)
    ZQRH (JLON,KFLEV) = PQR(JLON,KFLEV)
    ZQSH (JLON,KFLEV) = PQS(JLON,KFLEV)
  ENDDO
  DO JLEV= 1, KFLEV-1
    DO JLON = KIDIA, KFDIA
      ZQH (JLON,JLEV) = (PQ (JLON,JLEV)+PQ (JLON,JLEV+1))*0.5_JPRB
      ZQLH(JLON,JLEV) = (PQL(JLON,JLEV)+PQL(JLON,JLEV+1))*0.5_JPRB
      ZQIH(JLON,JLEV) = (PQI(JLON,JLEV)+PQI(JLON,JLEV+1))*0.5_JPRB
      ZQRH(JLON,JLEV) = (PQR(JLON,JLEV)+PQR(JLON,JLEV+1))*0.5_JPRB
      ZQSH(JLON,JLEV) = (PQS(JLON,JLEV)+PQS(JLON,JLEV+1))*0.5_JPRB
    ENDDO
  ENDDO
    IF (LGRAPRO) THEN
      DO JLON=KIDIA, KFDIA
        ZQGH (JLON,0) = 0.0_JPRB
        ZQGH (JLON,KFLEV) = PQG(JLON,KFLEV)
      ENDDO
      DO JLEV = 1, KFLEV-1
        DO JLON = KIDIA, KFDIA
          ZQGH(JLON,JLEV) = (PQG(JLON,JLEV)+PQG(JLON,JLEV+1))*0.5_JPRB
        ENDDO
      ENDDO
    ENDIF
ENDIF

! Transformation between absolute and relative precip fluxes

IF (LLDPSFI) THEN
  IF (LGRAPRO) THEN
    DO JLEV= 0, KFLEV
      DO JLON = KIDIA, KFDIA
        ZFPL(JLON,JLEV)=(1.0_JPRB-ZQRH(JLON,JLEV))*PFPLSL(JLON,JLEV)&
          & -ZQRH(JLON,JLEV)*(PFPLSN(JLON,JLEV)+PFPLSG(JLON,JLEV))
        ZFPN(JLON,JLEV)=(1.0_JPRB-ZQSH(JLON,JLEV))*PFPLSN(JLON,JLEV)&
          & -ZQSH(JLON,JLEV)*(PFPLSL(JLON,JLEV)+PFPLSG(JLON,JLEV))
        ZFPG(JLON,JLEV)=(1.0_JPRB-ZQGH(JLON,JLEV))*PFPLSG(JLON,JLEV)&
          & -ZQGH(JLON,JLEV)*(PFPLSL(JLON,JLEV)+PFPLSN(JLON,JLEV))
        ZFPLSL(JLON,JLEV)=ZFPL(JLON,JLEV)
        ZFPLSN(JLON,JLEV)=ZFPN(JLON,JLEV)
        ZFPLSG(JLON,JLEV)=ZFPG(JLON,JLEV)
        ZFPL(JLON,JLEV)=(1.0_JPRB-ZQRH(JLON,JLEV))*PFPLCL(JLON,JLEV)&
          & -ZQRH(JLON,JLEV)*(PFPLCN(JLON,JLEV))
        ZFPN(JLON,JLEV)=(1.0_JPRB-ZQSH(JLON,JLEV))*PFPLCN(JLON,JLEV)&
          & -ZQSH(JLON,JLEV)*(PFPLCL(JLON,JLEV))
        ZFPG(JLON,JLEV)=(1.0_JPRB-ZQGH(JLON,JLEV))*PFPLCG(JLON,JLEV)&
          & -ZQGH(JLON,JLEV)*(PFPLCG(JLON,JLEV))
        ZFPLCL(JLON,JLEV)=ZFPL(JLON,JLEV)
        ZFPLCN(JLON,JLEV)=ZFPN(JLON,JLEV)
        ZFPLCG(JLON,JLEV)=ZFPG(JLON,JLEV)
        ZFPL(JLON,JLEV)=ZFPLSL(JLON,JLEV)+ZFPLCL(JLON,JLEV)
        ZFPN(JLON,JLEV)=ZFPLSN(JLON,JLEV)+ZFPLCN(JLON,JLEV)
        ZFPG(JLON,JLEV)=ZFPLSG(JLON,JLEV)+ZFPLCG(JLON,JLEV)
        ZCPH=RCPD+ (RCPV-RCPD)*ZQH(JLON,JLEV)+&
         & (RCW-RCPD)*(ZQLH(JLON,JLEV)+ZQRH(JLON,JLEV))+ &
         & (RCS-RCPD)*(ZQIH(JLON,JLEV)+ZQSH(JLON,JLEV)+ZQGH(JLON,JLEV))
        ZCHAT(JLON,JLEV)=(ZCPH-RCW*ZQRH(JLON,JLEV)-&
          & RCS*(ZQSH(JLON,JLEV)+ZQGH(JLON,JLEV)))/&
          & (1.0_JPRB-ZQRH(JLON,JLEV)-ZQSH(JLON,JLEV)-ZQGH(JLON,JLEV))
        ZLIFT(JLON,JLEV)=(ZFPL(JLON,JLEV)+ZFPN(JLON,JLEV)+ZFPG(JLON,JLEV))/&
          & (1.0_JPRB-ZQRH(JLON,JLEV)-ZQSH(JLON,JLEV)-ZQGH(JLON,JLEV))
      ENDDO
    ENDDO
  ELSE
    DO JLEV= 0, KFLEV
      DO JLON = KIDIA, KFDIA
        ZFPL(JLON,JLEV)=(1.0_JPRB-ZQRH(JLON,JLEV))*PFPLSL(JLON,JLEV)&
          & -ZQRH(JLON,JLEV)*PFPLSN(JLON,JLEV)
        ZFPN(JLON,JLEV)=(1.0_JPRB-ZQSH(JLON,JLEV))*PFPLSN(JLON,JLEV)&
          & -ZQSH(JLON,JLEV)*PFPLSL(JLON,JLEV)
        ZFPLSL(JLON,JLEV)=ZFPL(JLON,JLEV)
        ZFPLSN(JLON,JLEV)=ZFPN(JLON,JLEV)
        ZFPL(JLON,JLEV)=(1.0_JPRB-ZQRH(JLON,JLEV))*PFPLCL(JLON,JLEV)&
          & -ZQRH(JLON,JLEV)*PFPLCN(JLON,JLEV)
        ZFPN(JLON,JLEV)=(1.0_JPRB-ZQSH(JLON,JLEV))*PFPLCN(JLON,JLEV)&
          & -ZQSH(JLON,JLEV)*PFPLCL(JLON,JLEV)
        ZFPLCL(JLON,JLEV)=ZFPL(JLON,JLEV)
        ZFPLCN(JLON,JLEV)=ZFPN(JLON,JLEV)
        ZFPL(JLON,JLEV)=ZFPLSL(JLON,JLEV)+ZFPLCL(JLON,JLEV)
        ZFPN(JLON,JLEV)=ZFPLSN(JLON,JLEV)+ZFPLCN(JLON,JLEV)
        ZCPH=RCPD+ (RCPV-RCPD)*ZQH(JLON,JLEV)+&
         & (RCW-RCPD)*(ZQLH(JLON,JLEV)+ZQRH(JLON,JLEV))+ &
         & (RCS-RCPD)*(ZQIH(JLON,JLEV)+ZQSH(JLON,JLEV))
        ZCHAT(JLON,JLEV)=(ZCPH-RCW*ZQRH(JLON,JLEV)-&
         & RCS*ZQSH(JLON,JLEV))/(1.0_JPRB-ZQRH(JLON,JLEV)-ZQSH(JLON,JLEV))
        ZLIFT(JLON,JLEV)=(ZFPL(JLON,JLEV)+ZFPN(JLON,JLEV))/&
          & (1.0_JPRB-ZQRH(JLON,JLEV)-ZQSH(JLON,JLEV))
      ENDDO
    ENDDO
  ENDIF
ELSE
  DO JLEV= 0, KFLEV
    DO JLON = KIDIA, KFDIA
      ZFPL(JLON,JLEV)=PFPLSL(JLON,JLEV)+PFPLCL(JLON,JLEV)
      ZFPN(JLON,JLEV)=PFPLSN(JLON,JLEV)+PFPLCN(JLON,JLEV)
    ENDDO
  ENDDO
  IF (LGRAPRO) THEN
    DO JLEV=0, KFLEV
      DO JLON = KIDIA, KFDIA
        ZFPG(JLON,JLEV)=PFPLSG(JLON,JLEV)
      ENDDO
    ENDDO
  ENDIF
ENDIF
! Diagnostics

DO JLEV= 0, KFLEV
  DO JLON = KIDIA, KFDIA

    IF (LLDPSFI) THEN

      PFHSCL(JLON,JLEV)=ZFPLCL(JLON,JLEV)*ZTI(JLON,JLEV)*RCW
      PFHSCN(JLON,JLEV)=ZFPLCN(JLON,JLEV)*ZTI(JLON,JLEV)*RCS
      PFHSSL(JLON,JLEV)=ZFPLSL(JLON,JLEV)*ZTI(JLON,JLEV)*RCW
      PFHSSN(JLON,JLEV)=ZFPLSN(JLON,JLEV)*ZTI(JLON,JLEV)*RCS
      IF (LGRAPRO) THEN
        PFHSSG(JLON,JLEV)=ZFPLSG(JLON,JLEV)*ZTI(JLON,JLEV)*RCS
      ELSE
        PFHSSG(JLON,JLEV)=0._JPRB
      ENDIF

    ELSE

      PFHSCL(JLON,JLEV)=PFPLCL(JLON,JLEV)*ZTI(JLON,JLEV)*(RCW-RCPD)
      PFHSCN(JLON,JLEV)=PFPLCN(JLON,JLEV)*ZTI(JLON,JLEV)*(RCS-RCPD)
      PFHSSL(JLON,JLEV)=PFPLSL(JLON,JLEV)*ZTI(JLON,JLEV)*(RCW-RCPD)
      PFHSSN(JLON,JLEV)=PFPLSN(JLON,JLEV)*ZTI(JLON,JLEV)*(RCS-RCPD)
      IF (LGRAPRO) THEN
        PFHSSG(JLON,JLEV)=PFPLSG(JLON,JLEV)*ZTI(JLON,JLEV)*(RCS-RCPD)
      ELSE
        PFHSSG(JLON,JLEV)=0._JPRB
      ENDIF

    ENDIF

    PFHPCL(JLON,JLEV)= - RLVZER * (PFCCQL(JLON,JLEV)-PFECL(JLON,JLEV))
    PFHPCN(JLON,JLEV)= - RLSZER * (PFCCQN(JLON,JLEV)-PFECN(JLON,JLEV))
    PFHPSL(JLON,JLEV)= - RLVZER * (PFCSQL(JLON,JLEV)-PFESL(JLON,JLEV))
    PFHPSN(JLON,JLEV)= - RLSZER * (PFCSQN(JLON,JLEV)-PFESN(JLON,JLEV))

    PFP(JLON,JLEV)= ZFPL(JLON,JLEV) +ZFPN(JLON,JLEV)

    IF (LGRAPRO) THEN
      PFHPSG(JLON,JLEV)= - RLSZER * (-PFESG(JLON,JLEV))
      PFHPCG(JLON,JLEV)= - RLSZER * (-PFECG(JLON,JLEV))
      PFP(JLON,JLEV)= PFP(JLON,JLEV) + ZFPG(JLON,JLEV)
    ELSE
      PFHPSG(JLON,JLEV)= 0._JPRB
      PFHPCG(JLON,JLEV)= 0._JPRB
    ENDIF

    PFEPFP(JLON,JLEV)=-NDPSFI*ZCHAT(JLON,JLEV)*ZTI(JLON,JLEV)*&
     & PFP(JLON,JLEV)

    PFHP(JLON,JLEV) = PFHSCL(JLON,JLEV) + PFHSCN(JLON,JLEV) +&
     & PFHSSL(JLON,JLEV) + PFHSSN(JLON,JLEV) +&
     & PFHPCL(JLON,JLEV) + PFHPCN(JLON,JLEV) +&
     & PFHPSL(JLON,JLEV) + PFHPSN(JLON,JLEV) +&
     & PFEPFP(JLON,JLEV)

    IF (LGRAPRO) THEN
      PFHP(JLON,JLEV) = PFHP(JLON,JLEV) + PFHSSG(JLON,JLEV) + PFHPSG(JLON,JLEV) + PFHPCG(JLON,JLEV)
    ENDIF
  ENDDO
ENDDO

! Computation of the total enthalpy flux J_tot (including NDPSFI==1)

DO JLEV= 0, KFLEV
  DO JLON = KIDIA, KFDIA
    ZJTOT(JLON,JLEV) = PFRSO(JLON,JLEV)+PFRTH(JLON,JLEV)+PFRMH(JLON,JLEV)+&
        & PDIFTS(JLON,JLEV)+PDIFCS(JLON,JLEV)+&
        & (RCW-RCPD)*ZFPL(JLON,JLEV)*ZTI(JLON,JLEV)+&
        & (RCS-RCPD)*ZFPN(JLON,JLEV)*ZTI(JLON,JLEV)-&
        & RLVZER*(PFCCQL(JLON,JLEV)+PFCSQL(JLON,JLEV)-PFESL(JLON,JLEV)&
        & -PFECL(JLON,JLEV))-&
        & RLSZER*(PFCCQN(JLON,JLEV)+PFCSQN(JLON,JLEV)-PFESN(JLON,JLEV)&
        & -PFECN(JLON,JLEV))&
        & +ZFHIMCC(JLON,JLEV)
  ENDDO
ENDDO

IF (LGRAPRO) THEN
 DO JLEV = 0, KFLEV
   DO JLON = KIDIA, KFDIA
     ZJTOT(JLON,JLEV) = ZJTOT(JLON,JLEV) + (RCS-RCPD)*ZFPG(JLON,JLEV)*ZTI(JLON,JLEV) +&
      & RLSZER*(PFESG(JLON,JLEV)+PFECG(JLON,JLEV))
   ENDDO
 ENDDO
ENDIF

IF (LLDPSFI) THEN
  DO JLEV= 0, KFLEV
    DO JLON = KIDIA, KFDIA
      ZFHDPSFI(JLON,JLEV) = -(ZCHAT(JLON,JLEV)-RCPD)*ZTI(JLON,JLEV)*&
          &  (ZFPL(JLON,JLEV)+ZFPN(JLON,JLEV))
      IF (LGRAPRO) THEN
        ZFHDPSFI(JLON,JLEV) = ZFHDPSFI(JLON,JLEV) - (ZCHAT(JLON,JLEV) - RCPD)*&
         &ZTI(JLON,JLEV)*ZFPG(JLON,JLEV)
      ENDIF
      ZJTOT(JLON,JLEV) = ZJTOT(JLON,JLEV)+ZFHDPSFI(JLON,JLEV)
    ENDDO
  ENDDO
ELSE
  ZFHDPSFI(KIDIA:KFDIA,0:KFLEV)=0.
ENDIF


!CDIR UNROLL=8
DO JLEV = 1, KFLEV
  DO JLON = KIDIA, KFDIA

    ZGSDP(JLON,JLEV)=RG*PRDELP(JLON,JLEV)

    PTENDU(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
     & (PSTRCU (JLON,JLEV-1) - PSTRCU (JLON,JLEV)) +&
     & (PSTRDU (JLON,JLEV-1) - PSTRDU (JLON,JLEV)) +&
     & (PSTRMU (JLON,JLEV-1) - PSTRMU (JLON,JLEV)) +&
     & (PSTRTU (JLON,JLEV-1) - PSTRTU (JLON,JLEV)) )

    PTENDV(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
     & (PSTRCV (JLON,JLEV-1) - PSTRCV (JLON,JLEV)) +&
     & (PSTRDV (JLON,JLEV-1) - PSTRDV (JLON,JLEV)) +&
     & (PSTRMV (JLON,JLEV-1) - PSTRMV (JLON,JLEV)) +&
     & (PSTRTV (JLON,JLEV-1) - PSTRTV (JLON,JLEV)) )

    IF (LCVTDK) THEN
  !     PTENDU_ZDEC(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
  !      & (PSTRDU (JLON,JLEV-1) - PSTRDU (JLON,JLEV)) +&
  !      & (PSTRMU (JLON,JLEV-1) - PSTRMU (JLON,JLEV)) +&
  !      & (PSTRTU (JLON,JLEV-1) - PSTRTU (JLON,JLEV)) )
     
       PTENDU_ZDEC(JLON,JLEV) = 0.0_JPRB
   !    PTENDV_ZDEC(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
   !     & (PSTRDV (JLON,JLEV-1) - PSTRDV (JLON,JLEV)) +&
   !     & (PSTRMV (JLON,JLEV-1) - PSTRMV (JLON,JLEV)) +&
   !     & (PSTRTV (JLON,JLEV-1) - PSTRTV (JLON,JLEV)) )
   
       PTENDV_ZDEC(JLON,JLEV) = 0.0_JPRB
    ELSE    
       PTENDU_ZDEC(JLON,JLEV) = PTENDU(JLON,JLEV) 
       PTENDV_ZDEC(JLON,JLEV) = PTENDV(JLON,JLEV)  
    ENDIF
       
    PTENDQ(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
     & (PDIFTQ (JLON,JLEV-1) - PDIFTQ (JLON,JLEV)) +&
     & (PDIFCQ (JLON,JLEV-1) - PDIFCQ (JLON,JLEV)) +&
     & (PFRMQ  (JLON,JLEV-1) - PFRMQ (JLON,JLEV))  +&
     & (PFCHQ  (JLON,JLEV-1) - PFCHQ (JLON,JLEV))  +&
     & (PFCCQL (JLON,JLEV-1) - PFCCQL (JLON,JLEV)) +&
     & (PFCCQN (JLON,JLEV-1) - PFCCQN (JLON,JLEV)) +&
     & (PFCSQL (JLON,JLEV-1) - PFCSQL (JLON,JLEV)) +&
     & (PFCSQN (JLON,JLEV-1) - PFCSQN (JLON,JLEV)) +&
     & (PFCQNG (JLON,JLEV-1) - PFCQNG (JLON,JLEV)) -&
     & (PFECL  (JLON,JLEV-1) - PFECL  (JLON,JLEV)) -&
     & (PFESL  (JLON,JLEV-1) - PFESL  (JLON,JLEV)) -&
     & (PFECN  (JLON,JLEV-1) - PFECN  (JLON,JLEV)) -&
     & (PFESN  (JLON,JLEV-1) - PFESN  (JLON,JLEV)))

    PTENDH(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
     &  ZJTOT  (JLON,JLEV-1) - ZJTOT  (JLON,JLEV))

  ENDDO
ENDDO

IF (LGRAPRO) THEN
!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQ(JLON,JLEV)=PTENDQ(JLON,JLEV) + ZGSDP(JLON,JLEV)*(-&
        & (PFESG(JLON,JLEV-1) - PFESG(JLON,JLEV)) - &
        & (PFECG(JLON,JLEV-1) - PFECG(JLON,JLEV)))
    ENDDO
  ENDDO
ENDIF

IF (LFLEXDIA) THEN
   IF (LDDH_OMP) THEN
     !-------------------------------------------------
    ! QV DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
    & PDELP(KIDIA:KFDIA,1:KFLEV)*PQ(KIDIA:KFDIA,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTQ,'FQVTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQ,'FQVTURCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCCQL,'FQVCCQL',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCCQN,'FQVCCQN',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCSQL,'FQVCSQL',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCSQN,'FQVCSQN',YDDDH)
    IF(LMUSCLFA) CALL WRSCMR(NMUSCLFA,'PFCQNG_CPTEND_NEW',PFCQNG,KFDIA,KFLEV+1)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQNG,'FQVCQNG',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFECL(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVECL',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFESL(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVESL',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFECN(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVECN',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFESN(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVESN',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFESG(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVESG',YDDDH)
    !-------------------------------------------------
    ! H (enthalpy) DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
    & PDELP(KIDIA:KFDIA,1:KFLEV)*PCP(KIDIA:KFDIA,1:KFLEV)*PT(KIDIA:KFDIA,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCT',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFRSO,'FCTRSO',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFRTH,'FCTRTH',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFRMH,'FCTRMH',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTS,'FCTDIFT',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCS,'FCTDIFC',YDDDH)
    ZFHSENS(KIDIA:KFDIA,0:KFLEV)=(RCW-RCPD)*ZFPL(KIDIA:KFDIA,0:KFLEV)*ZTI(KIDIA:KFDIA,0:KFLEV)+&
      & (RCS-RCPD)*ZFPN(KIDIA:KFDIA,0:KFLEV)*ZTI(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFHSENS,'FCTSENSPREC',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-RLVZER*PFCCQL(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCCQL',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-RLVZER*PFCSQL(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCSQL',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=RLVZER*PFESL(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTESL',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=RLVZER*PFECL(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTECL',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-RLSZER*PFCCQN(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCCQN',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-RLSZER*PFCSQN(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCSQN',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=RLSZER*PFESN(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTESN',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=RLSZER*PFECN(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTECN',YDDDH)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=RLSZER*PFESG(KIDIA:KFDIA,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTESG',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFHDPSFI,'FCTDPSFI',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFHIMCC,'FCTIMCC',YDDDH)
   ELSE
    !-------------------------------------------------
    ! QV DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
    & PDELP(KIDIA:KFDIA,1:KFLEV)*PQ(KIDIA:KFDIA,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQV','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PDIFTQ,'FQVTUR','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PDIFCQ,'FQVTURCONV','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFCCQL,'FQVCCQL','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFCCQN,'FQVCCQN','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFCSQL,'FQVCSQL','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFCSQN,'FQVCSQN','F','ARP',.TRUE.,.TRUE.)
    IF(LMUSCLFA) CALL WRSCMR(NMUSCLFA,'PFCQNG_CPTEND_NEW',PFCQNG,KFDIA,KFLEV+1)
    CALL ADD_FIELD_3D(YDLDDH,PFCQNG,'FQVCQNG','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFECL(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVECL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFESL(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVESL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFECN(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVECN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFESN(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVESN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFESG(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVESG','F','ARP',.TRUE.,.TRUE.)
    !-------------------------------------------------
    ! H (enthalpy) DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
    & PDELP(KIDIA:KFDIA,1:KFLEV)*PCP(KIDIA:KFDIA,1:KFLEV)*PT(KIDIA:KFDIA,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCT','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFRSO,'FCTRSO','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFRTH,'FCTRTH','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFRMH,'FCTRMH','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PDIFTS,'FCTDIFT','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PDIFCS,'FCTDIFC','F','ARP',.TRUE.,.TRUE.)
    ZFHSENS(KIDIA:KFDIA,0:KFLEV)=(RCW-RCPD)*ZFPL(KIDIA:KFDIA,0:KFLEV)*ZTI(KIDIA:KFDIA,0:KFLEV)+&
      & (RCS-RCPD)*ZFPN(KIDIA:KFDIA,0:KFLEV)*ZTI(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZFHSENS,'FCTSENSPREC','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-RLVZER*PFCCQL(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCCQL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-RLVZER*PFCSQL(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCSQL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=RLVZER*PFESL(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTESL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=RLVZER*PFECL(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTECL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-RLSZER*PFCCQN(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCCQN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-RLSZER*PFCSQN(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCSQN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=RLSZER*PFESN(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTESN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=RLSZER*PFECN(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTECN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=RLSZER*PFESG(KIDIA:KFDIA,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTESG','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZFHDPSFI,'FCTDPSFI','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZFHIMCC,'FCTIMCC','F','ARP',.TRUE.,.TRUE.)
  ENDIF
ENDIF


!  ------------------------------------------------------------
!   2. CALCUL DE L'EVOLUTION DE QL, QI, QR, QS, QG
!  ------------------------------------------------------------

! - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
! Pronostic equations for liquid/solid water/precipitation
! - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

IF (LCONDWT.AND..NOT.LGPCMT) THEN

  ! - - - - - - - - - - - - - - - - - -
  ! Usual equation for QL=suspended liquid water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQL(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & (PDIFTQL(JLON,JLEV-1) - PDIFTQL(JLON,JLEV)) +&
       & (PDIFCQL(JLON,JLEV-1) - PDIFCQL(JLON,JLEV)) +&
       & (PFCQLNG(JLON,JLEV-1) - PFCQLNG(JLON,JLEV)) +&
       & (PFACL  (JLON,JLEV-1) - PFACL  (JLON,JLEV)) +&
       & (PFASL  (JLON,JLEV-1) - PFASL  (JLON,JLEV)) -&
       & (PFCSQL (JLON,JLEV-1) - PFCSQL (JLON,JLEV)) -&
       & (PFCCQL (JLON,JLEV-1) - PFCCQL (JLON,JLEV)))
    ENDDO
  ENDDO
  IF (LFLEXDIA) THEN
    !-------------------------------------------------
    ! QL DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQL(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTQL,'FQLDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQL,'FQLDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQLNG,'FQLCQLNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFACL,'FQLACL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFASL,'FQLASL',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCSQL(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLCSQL',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCCQL(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLCCQL',YDDDH)
    ELSE
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQL(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQL','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFTQL,'FQLDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQL,'FQLDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQLNG,'FQLCQLNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFACL,'FQLACL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFASL,'FQLASL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCSQL(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLCSQL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCCQL(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLCCQL','F','ARP',.TRUE.,.TRUE.)
    ENDIF 
  ENDIF

  ! - - - - - - - - - - - - - - - - - -
  ! equation for QI=suspended ice water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQI(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & (PDIFTQI(JLON,JLEV-1) - PDIFTQI(JLON,JLEV)) +&
       & (PDIFCQI(JLON,JLEV-1) - PDIFCQI(JLON,JLEV)) +&
       & (PFCQING(JLON,JLEV-1) - PFCQING(JLON,JLEV)) +&
       & (PFACN  (JLON,JLEV-1) - PFACN  (JLON,JLEV)) +&
       & (PFASN  (JLON,JLEV-1) - PFASN  (JLON,JLEV)) -&
       & (PFCSQN (JLON,JLEV-1) - PFCSQN (JLON,JLEV)) -&
       & (PFCCQN (JLON,JLEV-1) - PFCCQN (JLON,JLEV)))
    ENDDO
  ENDDO
  IF (LGRAPRO) THEN
    DO JLEV = 1, KFLEV
      DO JLON = KIDIA, KFDIA
        PTENDQI(JLON,JLEV) = PTENDQI(JLON,JLEV) +ZGSDP(JLON,JLEV)*&
         &(PFASG  (JLON,JLEV-1) - PFASG  (JLON,JLEV))
      ENDDO
    ENDDO
  ENDIF
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QI DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQI(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQI',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTQI,'FQIDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQI,'FQIDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQING,'FQICQING',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFACN,'FQIACN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFASN,'FQIASN',YDDDH)
      IF (LGRAPRO) THEN
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFASG,'FQIASG',YDDDH)
      ENDIF
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCSQN(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQICSQN',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCCQN(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQICCQN',YDDDH)
    ELSE
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQI(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQI','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFTQI,'FQIDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQI,'FQIDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQING,'FQICQING','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFACN,'FQIACN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFASN,'FQIASN','F','ARP',.TRUE.,.TRUE.)
      IF (LGRAPRO) THEN
        CALL ADD_FIELD_3D(YDLDDH,PFASG,'FQIASG','F','ARP',.TRUE.,.TRUE.)
      ENDIF
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCSQN(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQICSQN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCCQN(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQICCQN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! -----------------------------------
  ! Equation for QR=rain water
  ! -----------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQR(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & (PFESL  (JLON,JLEV-1) - PFESL  (JLON,JLEV)) +&
       & (PFECL  (JLON,JLEV-1) - PFECL  (JLON,JLEV)) +&
       & (PFCQRNG(JLON,JLEV-1) - PFCQRNG(JLON,JLEV)) +&
       & (ZFPL   (JLON,JLEV-1) - ZFPL   (JLON,JLEV)) -&
       & (PFACL  (JLON,JLEV-1) - PFACL  (JLON,JLEV)) -&
       & (PFASL  (JLON,JLEV-1) - PFASL  (JLON,JLEV)))
    ENDDO
  ENDDO
  IF (LFLEXDIA) THEN
    !-------------------------------------------------
    ! QR DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQR(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQR',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFESL,'FQRESL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFECL,'FQRECL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQRNG,'FQRCQRNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFPL,'FQRPL',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFACL(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQRACL',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFASL(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQRASL',YDDDH)
    ELSE
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQR(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQR','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFESL,'FQRESL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFECL,'FQRECL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQRNG,'FQRCQRNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,ZFPL,'FQRPL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFACL(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQRACL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFASL(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQRASL','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! ---------------------------------
  ! Equation for QS=snow water
  ! --------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQS(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & (PFESN  (JLON,JLEV-1) - PFESN  (JLON,JLEV)) +&
       & (PFECN  (JLON,JLEV-1) - PFECN  (JLON,JLEV)) +&
       & (PFCQSNG(JLON,JLEV-1) - PFCQSNG(JLON,JLEV)) +&
       & (ZFPN   (JLON,JLEV-1) - ZFPN   (JLON,JLEV)) -&
       & (PFACN  (JLON,JLEV-1) - PFACN  (JLON,JLEV)) -&
       & (PFASN  (JLON,JLEV-1) - PFASN  (JLON,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QS DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQS(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQS',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFESN,'FQSESN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFECN,'FQSECN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQSNG,'FQSCQSNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFPN,'FQSPN',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFACN(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSACN',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFASN(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSASN',YDDDH)
    ELSE
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQS(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQS','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFESN,'FQSESN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFECN,'FQSECN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQSNG,'FQSCQSNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,ZFPN,'FQSPN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFACN(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSACN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFASN(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSASN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! ---------------------------------
  ! Equation for QG=graupel
  ! --------------------------------
  IF (LGRAPRO) THEN
  !cdir unroll=8
    DO JLEV = 1, KFLEV
      DO JLON = KIDIA, KFDIA
        PTENDQG(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
         & (PFESG  (JLON,JLEV-1) - PFESG  (JLON,JLEV)) +&
         & (PFECG  (JLON,JLEV-1) - PFECG  (JLON,JLEV)) +&
         & (PFCQGNG(JLON,JLEV-1) - PFCQGNG(JLON,JLEV)) +&
         & (ZFPG   (JLON,JLEV-1) - ZFPG   (JLON,JLEV)) -&
         & (PFASG  (JLON,JLEV-1) - PFASG  (JLON,JLEV)))
      ENDDO
    ENDDO
    IF(LFLEXDIA) THEN
      !-------------------------------------------------
      ! QG DDH budget.
      !-------------------------------------------------
      IF (LDDH_OMP) THEN
        ZTMPVAR(KIDIA:KFDIA,1:KFLEV)= &
        & PDELP(KIDIA:KFDIA,1:KFLEV)*PQG(KIDIA:KFDIA,1:KFLEV)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFESG,'FQGESG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFECG,'FQGECG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQGNG,'FQGCQGNG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFPG,'FQGPG',YDDDH)
        ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFASG(KIDIA:KFDIA,0:KFLEV)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQGASG',YDDDH)
      ELSE
        ZTMPVAR(KIDIA:KFDIA,1:KFLEV)= &
        & PDELP(KIDIA:KFDIA,1:KFLEV)*PQG(KIDIA:KFDIA,1:KFLEV)
        CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQG','V','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,PFESG,'FQGESG','F','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,PFECG,'FQGECG','F','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,PFCQGNG,'FQGCQGNG','F','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,ZFPG,'FQGPG','F','ARP',.TRUE.,.TRUE.)
        ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFASG(KIDIA:KFDIA,0:KFLEV)
        CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQGASG','F','ARP',.TRUE.,.TRUE.)
      ENDIF
    ENDIF
  ENDIF


ELSEIF(LCONDWT.AND.LGPCMT) THEN

  ! - - - - - - - - - - - - - - - - - -
  ! PCMT convection scheme.
  ! - - - - - - - - - - - - - - - - - -

  ! - - - - - - - - - - - - - - - - - -
  ! Usual equation for QL=suspended liquid water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQL(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & (PDIFTQL(JLON,JLEV-1) - PDIFTQL(JLON,JLEV)) +&
       & (PDIFCQL(JLON,JLEV-1) - PDIFCQL(JLON,JLEV)) +&
       & (PFCQLNG(JLON,JLEV-1) - PFCQLNG(JLON,JLEV)) -&
       & (PFEDQLC(JLON,JLEV-1) - PFEDQLC(JLON,JLEV)) +&
       & (PFASL  (JLON,JLEV-1) - PFASL  (JLON,JLEV)) -&
       & (PFCSQL (JLON,JLEV-1) - PFCSQL (JLON,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QL DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQL(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTQL,'FQLDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQL,'FQLDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQLNG,'FQLCQLNG',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFEDQLC(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLEDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFASL,'FQLASL',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCSQL(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLCSQL',YDDDH)
    ELSE
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQL(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQL','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFTQL,'FQLDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQL,'FQLDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQLNG,'FQLCQLNG','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFEDQLC(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLEDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFASL,'FQLASL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCSQL(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLCSQL','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! - - - - - - - - - - - - - - - - - -
  ! equation for QI=suspended ice water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQI(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & (PDIFTQI(JLON,JLEV-1) - PDIFTQI(JLON,JLEV)) +&
       & (PDIFCQI(JLON,JLEV-1) - PDIFCQI(JLON,JLEV)) +&
       & (PFCQING(JLON,JLEV-1) - PFCQING(JLON,JLEV)) -&
       & (PFEDQIC(JLON,JLEV-1) - PFEDQIC(JLON,JLEV)) +&
       & (PFASN  (JLON,JLEV-1) - PFASN  (JLON,JLEV)) -&
       & (PFCSQN (JLON,JLEV-1) - PFCSQN (JLON,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QI DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQI(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQI',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTQI,'FQIDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQI,'FQIDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQING,'FQICQING',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFEDQIC(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQIEDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFASN,'FQIASN',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCSQN(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQICSQN',YDDDH)
    ELSE
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQI(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQI','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFTQI,'FQIDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQI,'FQIDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQING,'FQICQING','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFEDQIC(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQIEDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFASN,'FQIASN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCSQN(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQICSQN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! -----------------------------------
  ! Equation for QR=rain water
  ! -----------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQR(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & (PFESL  (JLON,JLEV-1) - PFESL  (JLON,JLEV)) +&
       & (PFCQRNG(JLON,JLEV-1) - PFCQRNG(JLON,JLEV)) -&
       & (PFEDQRC(JLON,JLEV-1) - PFEDQRC(JLON,JLEV)) +&
       & (PFPLSL (JLON,JLEV-1) - PFPLSL (JLON,JLEV)) -&
       & (PFASL  (JLON,JLEV-1) - PFASL  (JLON,JLEV)))
    ENDDO
  ENDDO
  IF (LFLEXDIA) THEN
    !-------------------------------------------------
    ! QR DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQR(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQR',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFESL,'FQRESL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQRNG,'FQRCQRNG',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFEDQRC(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQREDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFPLSL,'FQRPL',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFASL(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQRASL',YDDDH)
    ELSE   
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQR(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQR','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFESL,'FQRESL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQRNG,'FQRCQRNG','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFEDQRC(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQREDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFPLSL,'FQRPL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFASL(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQRASL','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! ---------------------------------
  ! Equation for QS=snow water
  ! --------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQS(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & (PFESN  (JLON,JLEV-1) - PFESN  (JLON,JLEV)) +&
       & (PFCQSNG(JLON,JLEV-1) - PFCQSNG(JLON,JLEV)) -&
       & (PFEDQSC(JLON,JLEV-1) - PFEDQSC(JLON,JLEV)) +&
       & (PFPLSN (JLON,JLEV-1) - PFPLSN (JLON,JLEV)) -&
       & (PFASN  (JLON,JLEV-1) - PFASN  (JLON,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QS DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQS(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQS',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFESN,'FQSESN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQSNG,'FQSCQSNG',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFEDQSC(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSEDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFPLSN,'FQSPN',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFASN(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSASN',YDDDH)
    ELSE
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQS(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQS','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFESN,'FQSESN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQSNG,'FQSCQSNG','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFEDQSC(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSEDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFPLSN,'FQSPN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFASN(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSASN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! - - - - - - - - - - - - - - - - - -
  ! Equation for QLCONV=suspended liquid water (CONV. PART)
  ! - - - - - - - - - - - - - - - - - -
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQLCONV(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & +(PFCNEGQLC(JLON,JLEV-1) - PFCNEGQLC(JLON,JLEV))&
       & +(PDIFCQLC(JLON,JLEV-1)  - PDIFCQLC(JLON,JLEV))&
       & +(PFEDQLC(JLON,JLEV-1)   - PFEDQLC(JLON,JLEV))&
       & +(PFIMCC(JLON,JLEV-1)    - PFIMCC(JLON,JLEV))&
       & -(PFCCQL (JLON,JLEV-1)   - PFCCQL (JLON,JLEV))&
       & +(PFACL  (JLON,JLEV-1)   - PFACL  (JLON,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QLCONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQLCONV(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCNEGQLC,'FCLCQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQLC,'FCLDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFEDQLC,'FCLED',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFIMCC,'FCLIM',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCCQL(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCLCOND',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFACL,'FCLAUTOCONV',YDDDH)
    ELSE 
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQLCONV(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCL','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCNEGQLC,'FCLCQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQLC,'FCLDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFEDQLC,'FCLED','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFIMCC,'FCLIM','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCCQL(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCLCOND','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFACL,'FCLAUTOCONV','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! - - - - - - - - - - - - - - - - - -
  ! Equation for QICONV=suspended ice water (CONV. PART)
  ! - - - - - - - - - - - - - - - - - -
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQICONV(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & +(PFCNEGQIC(JLON,JLEV-1) - PFCNEGQIC(JLON,JLEV))&
       & +(PDIFCQIC(JLON,JLEV-1)  - PDIFCQIC(JLON,JLEV))&
       & +(PFEDQIC(JLON,JLEV-1)   - PFEDQIC(JLON,JLEV))&
       & -(PFIMCC(JLON,JLEV-1)    - PFIMCC(JLON,JLEV))&
       & -(PFCCQN (JLON,JLEV-1)   - PFCCQN (JLON,JLEV))&
       & +(PFACN  (JLON,JLEV-1)   - PFACN  (JLON,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QICONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQICONV(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCI',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCNEGQIC,'FCICQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQIC,'FCIDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFEDQIC,'FCIED',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFIMCC(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCIIM',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCCQN(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCICOND',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFACN,'FCIAUTOCONV',YDDDH)
    ELSE
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQICONV(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCI','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCNEGQIC,'FCICQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQIC,'FCIDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFEDQIC,'FCIED','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFIMCC(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCIIM','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFCCQN(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCICOND','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFACN,'FCIAUTOCONV','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! -----------------------------------
  ! Equation for QRCONV=rain (CONV. PART)
  ! -----------------------------------
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQRCONV(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & +(PFCNEGQRC(JLON,JLEV-1) - PFCNEGQRC(JLON,JLEV))&
       & +(PFPLCL (JLON,JLEV-1)   - PFPLCL (JLON,JLEV))&
       & +(PFEDQRC(JLON,JLEV-1)   - PFEDQRC(JLON,JLEV))&
       & -(PFACL  (JLON,JLEV-1)   - PFACL  (JLON,JLEV))&
       & +(PFECL  (JLON,JLEV-1)   - PFECL  (JLON,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QRCONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQRCONV(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCR',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCNEGQRC,'FCRCQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFPLCL,'FCRSEDIM',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFEDQRC,'FCRED',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFACL(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCRAUTOCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFECL,'FCREVAPO',YDDDH)
    ELSE
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQRCONV(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCR','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCNEGQRC,'FCRCQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFPLCL,'FCRSEDIM','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFEDQRC,'FCRED','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFACL(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCRAUTOCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFECL,'FCREVAPO','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! ---------------------------------
  ! Equation for QSCONV=snow (CONV. PART)
  ! --------------------------------
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDQSCONV(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & +(PFCNEGQSC(JLON,JLEV-1) - PFCNEGQSC(JLON,JLEV))&
       & +(PFPLCN (JLON,JLEV-1)   - PFPLCN (JLON,JLEV))&
       & +(PFEDQSC(JLON,JLEV-1)   - PFEDQSC(JLON,JLEV))&
       & -(PFACN  (JLON,JLEV-1)   - PFACN  (JLON,JLEV))&
       & +(PFECN  (JLON,JLEV-1)   - PFECN  (JLON,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QSCONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQSCONV(KIDIA:KFDIA,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCS',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCNEGQSC,'FCSCQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFPLCN,'FCSSEDIM',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFEDQSC,'FCSED',YDDDH)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFACN(KIDIA:KFDIA,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCSAUTOCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFECN,'FCSEVAPO',YDDDH)
    ELSE
      ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*PQSCONV(KIDIA:KFDIA,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCS','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCNEGQSC,'FCSCQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFPLCN,'FCSSEDIM','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFEDQSC,'FCSED','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KIDIA:KFDIA,0:KFLEV)=-PFACN(KIDIA:KFDIA,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCSAUTOCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFECN,'FCSEVAPO','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
ENDIF

!     For DDH, could be used in next loop for PTENDQ, PTENDQI,PTENDQL
IF (LFLEXDIA) THEN
  IF (LLDPSFI) THEN
    DO JLEV = 0, KFLEV
      DO JLON = KIDIA, KFDIA
        PFCMPCQ(JLON,JLEV) = ZQH(JLON,JLEV)*ZLIFT(JLON,JLEV)
        IF (LCONDWT) THEN
           PFCMPSN(JLON,JLEV) = ZQIH(JLON,JLEV)*ZLIFT(JLON,JLEV)
           PFCMPSL(JLON,JLEV) = ZQLH(JLON,JLEV)*ZLIFT(JLON,JLEV)
         ENDIF
      ENDDO
    ENDDO
  ELSE
    DO JLEV = 0, KFLEV
      DO JLON = KIDIA, KFDIA
        PFCMPCQ(JLON,JLEV) =  0.0_JPRB
        IF (LCONDWT) THEN
           PFCMPSN(JLON,JLEV) =  0.0_JPRB
           PFCMPSL(JLON,JLEV) =  0.0_JPRB
         ENDIF
      ENDDO
    ENDDO
  ENDIF
ENDIF

IF (LLDPSFI) THEN
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
       PTENDQ(JLON,JLEV) = PTENDQ(JLON,JLEV)-ZGSDP(JLON,JLEV)*&
         & (ZQH(JLON,JLEV-1)*ZLIFT(JLON,JLEV-1)-&
         & ZQH(JLON,JLEV)*ZLIFT(JLON,JLEV))
       IF (LCONDWT) THEN
         PTENDQI(JLON,JLEV) = PTENDQI(JLON,JLEV)-ZGSDP(JLON,JLEV)*&
           & (ZQIH(JLON,JLEV-1)*ZLIFT(JLON,JLEV-1)-&
           & ZQIH(JLON,JLEV)*ZLIFT(JLON,JLEV))
         PTENDQL(JLON,JLEV) = PTENDQL(JLON,JLEV)-ZGSDP(JLON,JLEV)*&
           & (ZQLH(JLON,JLEV-1)*ZLIFT(JLON,JLEV-1)-&
           & ZQLH(JLON,JLEV)*ZLIFT(JLON,JLEV))
       ENDIF
    ENDDO
  ENDDO
ENDIF

!  ------------------------------------------------------------
!   3. CALCUL DE L'EVOLUTION DE TKE
!  ------------------------------------------------------------

IF (LECT) THEN
  IF (JPRD == JPRB) THEN
    DO JLEV = 1, KFLEV
      DO JLON = KIDIA, KFDIA
        PTENDTKE(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
         & PFTKE (JLON,JLEV-1) - PFTKE (JLON,JLEV))
      ENDDO
    ENDDO
  ELSE
! This appears to be a more precise calculation of the TKE tendency
! but is not compatible with the interface of cptend_new and needs
! to be reviewed
    DO JLEV = 1, KFLEV
      DO JLON = KIDIA, KFDIA
        PTENDTKE(JLON,JLEV) = PFTKEI (JLON, JLEV)
      ENDDO
    ENDDO
  ENDIF
ENDIF

!  ------------------------------------------------------------
!   3.1 CALCUL DE L'EVOLUTION DE EFB1, EFB2 and EFB3
!  ------------------------------------------------------------

IF (LEFB) THEN
  DO JLEV = 1, KFLEV
    DO JLON = KIDIA, KFDIA
      PTENDEFB1(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & PFEFB1 (JLON,JLEV-1) - PFEFB1 (JLON,JLEV))
      PTENDEFB2(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & PFEFB2 (JLON,JLEV-1) - PFEFB2 (JLON,JLEV))
      PTENDEFB3(JLON,JLEV) = ZGSDP(JLON,JLEV)*(&
       & PFEFB3 (JLON,JLEV-1) - PFEFB3 (JLON,JLEV))
    ENDDO
  ENDDO
ENDIF

!  ------------------------------------------------------------
!   ?. CALCUL DE L'EVOLUTION DES SCALAIRES PASSIFS
!  ------------------------------------------------------------

IF(LMDUST.AND.(NGFL_EXT/=0)) THEN
  DO JGFL = 1, NGFL_EXT
    DO JLEV = 1, KFLEV
      DO JLON = KIDIA, KFDIA
        PTENDEXT(JLON,JLEV,JGFL) = ZGSDP(JLON,JLEV)*(&
          & PDIFEXT(JLON,JLEV-1,JGFL) - PDIFEXT(JLON,JLEV,JGFL))
      ENDDO
    ENDDO
  ENDDO
ENDIF
!

!  ------------------------------------------------------------
!   4. CALCUL DE L'EVOLUTION DE P ET W (CAS NH)
!  ------------------------------------------------------------

! TO DO

!--------------------------------------------------------------------------

IF(LFLEXDIA) THEN

  !-------------------------------------------------
  ! U AND V DDH Budget.
  !-------------------------------------------------

  DO JLEV = 0, KFLEV
    DO JLON=KIDIA,KFDIA
      ZSTTUG(JLON,JLEV) = PGNORDM(JLON)*PSTRTU(JLON,JLEV)-&
      & PGNORDL(JLON)*PSTRTV(JLON,JLEV)
      ZSTTVG(JLON,JLEV) = PGNORDL(JLON)*PSTRTU(JLON,JLEV)+&
      & PGNORDM(JLON)*PSTRTV(JLON,JLEV)
      ZSTCUG(JLON,JLEV) = PGNORDM(JLON)*PSTRCU(JLON,JLEV)-&
      & PGNORDL(JLON)*PSTRCV(JLON,JLEV)
      ZSTCVG(JLON,JLEV) = PGNORDL(JLON)*PSTRCU(JLON,JLEV)+&
      & PGNORDM(JLON)*PSTRCV(JLON,JLEV)
      ZSTDUG(JLON,JLEV) = PGNORDM(JLON)*PSTRDU(JLON,JLEV)-&
      & PGNORDL(JLON)*PSTRDV(JLON,JLEV)
      ZSTDVG(JLON,JLEV) = PGNORDL(JLON)*PSTRDU(JLON,JLEV)+&
      & PGNORDM(JLON)*PSTRDV(JLON,JLEV)
    ENDDO
  ENDDO

  DO JLEV = 1, KFLEV
    DO JLON=KIDIA,KFDIA
      ZUZGEO(JLON,JLEV)=PGNORDM(JLON)*PU(JLON,JLEV)-PGNORDL(JLON)*PV(JLON,JLEV)
      ZVMGEO(JLON,JLEV)=PGNORDL(JLON)*PU(JLON,JLEV)+PGNORDM(JLON)*PV(JLON,JLEV)
    ENDDO
  ENDDO

  IF (LDDH_OMP) THEN
     ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
    & PDELP(KIDIA:KFDIA,1:KFLEV)*PU(KIDIA:KFDIA,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VUU',YDDDH)
    ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
    & PDELP(KIDIA:KFDIA,1:KFLEV)*PV(KIDIA:KFDIA,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VVV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTTUG,'FUUTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTTVG,'FVVTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTCUG,'FUUTURCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTCVG,'FVVTURCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTDUG,'FUUONDEGREL',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTDVG,'FVVONDEGREL',YDDDH)
  ELSE
    ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
    & PDELP(KIDIA:KFDIA,1:KFLEV)*PU(KIDIA:KFDIA,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VUU','V','ARP',.TRUE.,.TRUE.)
    ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
    & PDELP(KIDIA:KFDIA,1:KFLEV)*PV(KIDIA:KFDIA,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VVV','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTTUG,'FUUTUR','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTTVG,'FVVTUR','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTCUG,'FUUTURCONV','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTCVG,'FVVTURCONV','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTDUG,'FUUONDEGREL','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTDVG,'FVVONDEGREL','F','ARP',.TRUE.,.TRUE.)
  ENDIF

  !-------------------------------------------------
  ! Kinetic Energy DDH budget.
  !-------------------------------------------------

  DO JLEV=1,KFLEV
    DO JLON=KIDIA,KFDIA
!     VKK
      ZKENE(JLON,JLEV)  = 0.5_JPRB*&
      & (PU(JLON,JLEV)**2+PV(JLON,JLEV)**2)
!     TKKDISSIPTUR
      ZTNDKKT(JLON,JLEV) = -( ZUZGEO(JLON,JLEV)*&
       & (ZSTTUG(JLON,JLEV)-ZSTTUG(JLON,JLEV-1)) + ZVMGEO(JLON,JLEV)&
       & *(ZSTTVG(JLON,JLEV)-ZSTTVG(JLON,JLEV-1)) )
!     TKKDISSIPCONV
      ZTNDKKC(JLON,JLEV) = -( ZUZGEO(JLON,JLEV)*&
       & (ZSTCUG(JLON,JLEV)-ZSTCUG(JLON,JLEV-1)) + ZVMGEO(JLON,JLEV)&
       & *(ZSTCVG(JLON,JLEV)-ZSTCVG(JLON,JLEV-1)) )
!     TKKDISSIPGREL
      ZTNDKKD(JLON,JLEV) = -( ZUZGEO(JLON,JLEV)*&
       & (ZSTDUG(JLON,JLEV)-ZSTDUG(JLON,JLEV-1)) + ZVMGEO(JLON,JLEV)&
       & *(ZSTDVG(JLON,JLEV)-ZSTDVG(JLON,JLEV-1)) )
    ENDDO
  ENDDO

  IF(LDDH_OMP) THEN
    ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*ZKENE(KIDIA:KFDIA,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VKK',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTNDKKT,'TKKDISSTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTNDKKC,'TKKDISSCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTNDKKD,'TKKDISSGREL',YDDDH)
  ELSE
    ZTMPVAR(KIDIA:KFDIA,1:KFLEV)=&
      & PDELP(KIDIA:KFDIA,1:KFLEV)*ZKENE(KIDIA:KFDIA,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VKK','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZTNDKKT,'TKKDISSTUR','T','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZTNDKKC,'TKKDISSCONV','T','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZTNDKKD,'TKKDISSGREL','T','ARP',.TRUE.,.TRUE.)
  ENDIF

ENDIF
IF(LMUSCLFA) THEN

  !-------------------------------------------------
  ! Single column model MUSC diagnostics.
  ! Q1 and Q2.
  !-------------------------------------------------

  DO JLEV=1,KFLEV
    DO JLON=KIDIA,KFDIA
      ZQ1(JLON,JLEV)=(PTENDH(JLON,JLEV)-(RCPV-RCPD)*PTENDQ(JLON,JLEV)*PT(JLON,JLEV))/PCP(JLON,JLEV)
      ZQ2(JLON,JLEV)=-FOLH(PT(JLON,JLEV),MAX(0._JPRB,SIGN(1._JPRB,RTT-PT(JLON,JLEV))))&
        & *PTENDQ(JLON,JLEV)/PCP(JLON,JLEV)
    ENDDO
  ENDDO
  CALL WRSCMR(NMUSCLFA,'Q1',ZQ1,KFDIA,KFLEV)
  CALL WRSCMR(NMUSCLFA,'Q2',ZQ2,KFDIA,KFLEV)

ENDIF

!-----------------------------------------------------------------------
END ASSOCIATE
END ASSOCIATE

IF (LHOOK) CALL DR_HOOK('CPTEND_NEW',1,ZHOOK_HANDLE)
END SUBROUTINE CPTEND_NEW

